<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - PMM Welfare Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-[#FDF8F5] text-[#3E2723] font-sans">

    <div class="flex min-h-screen">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-[#5D4037] text-white transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out shadow-2xl">
            <div class="p-8 text-center">
                <h1 class="text-2xl font-black italic flex items-center justify-center gap-2">
                    <i data-lucide="box"></i> PMM Welfare.
                </h1>
            </div>
         <nav class="mt-6 px-4 space-y-2">
    <a href="admin.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-white/10 transition">
        <i data-lucide="layout-dashboard"></i> Dashboard
    </a>
    
    <a href="admin-bin-card.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-white/10 transition">
        <i data-lucide="clipboard-list"></i> Bin Card
    </a>
    
    <a href="admin-items.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-white/10 transition">
        <i data-lucide="package"></i> Store Items
    </a>
    
    <a href="admin-orders.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-white/10 transition">
        <i data-lucide="shopping-bag"></i> Orders
    </a>
    
    <a href="admin-staff.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-white/10 transition group">
        <i data-lucide="users"></i> Staff Members
    </a>

    <a href="admin-settings.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-white/10 transition group">
        <i data-lucide="settings"></i> System Settings
    </a>

    <div class="pt-20">
        <button id="logoutBtn" class="flex items-center gap-3 p-4 w-full rounded-2xl hover:bg-red-500 transition text-red-100">
            <i data-lucide="log-out"></i> Logout
        </button>
    </div>
</nav>
        </aside>

        <main class="flex-1 lg:ml-64 p-4 lg:p-10">
            <header class="flex justify-between items-center mb-10">
                <div class="flex flex-col">
                    <h2 class="text-3xl font-black text-[#5D4037]">Welfare Dashboard</h2>
                    <p class="text-[#8D6E63] font-medium italic">Overview of PMM Welfare Shop activities</p>
                </div>
                <div class="text-right bg-white py-2 px-6 rounded-2xl shadow-sm border border-[#F5EBE0]">
                    <p class="font-black text-[#5D4037]" id="adminNameDisplay">Admin User</p>
                    <p class="text-[10px] uppercase tracking-widest text-[#8D6E63] font-bold">Main Administrator</p>
                </div>
            </header>

            <section class="space-y-10">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-[#F5EBE0]">
                        <div class="bg-green-100 text-green-600 w-12 h-12 rounded-2xl flex items-center justify-center mb-4">
                            <i data-lucide="trending-up"></i>
                        </div>
                        <p class="text-[#8D6E63] text-[10px] font-black uppercase tracking-widest">Total Staff Savings</p>
                        <h3 class="text-2xl font-black mt-1 text-green-600" id="stat-savings">Rs. 0</h3>
                    </div>

                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-[#F5EBE0]">
                        <div class="bg-orange-100 text-orange-600 w-12 h-12 rounded-2xl flex items-center justify-center mb-4">
                            <i data-lucide="shopping-cart"></i>
                        </div>
                        <p class="text-[#8D6E63] text-[10px] font-black uppercase tracking-widest">Welfare Sales</p>
                        <h3 class="text-2xl font-black mt-1 text-[#5D4037]" id="stat-revenue">Rs. 0</h3>
                    </div>

                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-[#F5EBE0]">
                        <div class="bg-blue-100 text-blue-600 w-12 h-12 rounded-2xl flex items-center justify-center mb-4">
                            <i data-lucide="users"></i>
                        </div>
                        <p class="text-[#8D6E63] text-[10px] font-black uppercase tracking-widest">Active Staff</p>
                        <h3 class="text-2xl font-black mt-1 text-[#5D4037]" id="stat-staff">0</h3>
                    </div>

                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-[#F5EBE0]">
                        <div class="bg-purple-100 text-purple-600 w-12 h-12 rounded-2xl flex items-center justify-center mb-4">
                            <i data-lucide="package"></i>
                        </div>
                        <p class="text-[#8D6E63] text-[10px] font-black uppercase tracking-widest">Inventory Items</p>
                        <h3 class="text-2xl font-black mt-1 text-[#5D4037]" id="stat-items">0</h3>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-[3rem] shadow-sm border border-[#F5EBE0]">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-xl font-black text-[#5D4037]">Recent Order Activities</h3>
                        <a href="admin-orders.html" class="text-xs font-bold text-[#8D6E63] hover:text-[#5D4037] underline">View All Orders</a>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="text-[#8D6E63] text-[10px] uppercase tracking-widest border-b border-[#FDF8F5]">
                                    <th class="pb-4">Date</th>
                                    <th class="pb-4">Staff Member</th>
                                    <th class="pb-4">Product</th>
                                    <th class="pb-4">Welfare Total</th>
                                    <th class="pb-4">Status</th>
                                </tr>
                            </thead>
                            <tbody id="dashboardOrderTable" class="text-sm font-medium">
                                </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, limit, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3jlpc_vbUydda2XpDj5Xd1J8kVei9v8U",
            authDomain: "inventory-c3cca.firebaseapp.com",
            projectId: "inventory-c3cca",
            storageBucket: "inventory-c3cca.firebasestorage.app",
            messagingSenderId: "396140403894",
            appId: "1:396140403894:web:316617b8e390f8b0575a17",
            measurementId: "G-YK5X3Z6HER"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === "admin") {
                    document.getElementById('adminNameDisplay').innerText = userDoc.data().name;
                    loadRealtimeDashboard();
                } else { window.location.href = "admin-login.html"; }
            } else { window.location.href = "admin-login.html"; }
        });

        function loadRealtimeDashboard() {
            // 1. Load Stats
            onSnapshot(collection(db, "orders"), (snap) => {
                let revenue = 0;
                let savings = 0;
                snap.forEach(d => {
                    revenue += d.data().total || 0;
                    savings += d.data().savings || 0;
                });
                document.getElementById('stat-revenue').innerText = "Rs. " + revenue.toLocaleString();
                document.getElementById('stat-savings').innerText = "Rs. " + savings.toLocaleString();
            });

            onSnapshot(collection(db, "users"), (snap) => {
                const staffCount = snap.docs.filter(d => d.data().role === 'staff').length;
                document.getElementById('stat-staff').innerText = staffCount;
            });

            onSnapshot(collection(db, "items"), (snap) => {
                document.getElementById('stat-items').innerText = snap.size;
            });

            // 2. Load Recent Orders (Last 5)
            const qRecent = query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(5));
            onSnapshot(qRecent, (snap) => {
                const table = document.getElementById('dashboardOrderTable');
                table.innerHTML = '';
                snap.forEach(d => {
                    const order = d.data();
                    const status = order.status || "Pending";
                    let statusColor = status === "Completed" ? "text-green-600 bg-green-50" : (status === "Dispatched" ? "text-blue-600 bg-blue-50" : "text-orange-600 bg-orange-50");

                    table.innerHTML += `
                        <tr class="border-b border-[#FDF8F5] hover:bg-[#FDF8F5] transition">
                            <td class="py-5 font-bold text-[#5D4037]">${order.createdAt?.toDate().toLocaleDateString() || 'Today'}</td>
                            <td class="py-5">
                                <p class="font-black text-xs">${order.staffName}</p>
                                <p class="text-[9px] text-[#8D6E63] uppercase">${order.userPosition}</p>
                            </td>
                            <td class="py-5 text-xs">${order.itemName}</td>
                            <td class="py-5 font-black text-[#5D4037]">Rs. ${order.total.toLocaleString()}</td>
                            <td class="py-5">
                                <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-tighter ${statusColor}">
                                    ${status}
                                </span>
                            </td>
                        </tr>
                    `;
                });
                lucide.createIcons();
            });
        }

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth).then(() => window.location.href = "admin-login.html"));
        lucide.createIcons();
    </script>
</body>
</html>