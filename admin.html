<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - PMM Welfare Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Sidebar transition for mobile */
        #sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-open { transform: translateX(0) !important; }
    </style>
</head>
<body class="bg-[#F0FDF4] text-[#064E3B] font-sans">

    <div id="sidebarOverlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <div class="flex min-h-screen">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-[#064E3B] text-white transform -translate-x-full lg:translate-x-0 shadow-2xl flex flex-col">
            <div class="p-8 text-center border-b border-emerald-800/50 flex justify-between items-center">
                <h1 class="text-2xl font-black italic flex items-center justify-center gap-2">
                    <i data-lucide="box"></i> PMM Welfare.
                </h1>
                <button class="lg:hidden text-white" onclick="toggleSidebar()">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <nav class="mt-6 px-4 space-y-2 flex-1">
                <a href="admin.html" class="flex items-center gap-3 p-4 rounded-2xl bg-emerald-600/30 border border-emerald-500/30 transition">
                    <i data-lucide="layout-dashboard"></i> Dashboard
                </a>
                <a href="admin-bin-card.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition">
                    <i data-lucide="clipboard-list"></i> Bin Card
                </a>
                <a href="admin-items.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition">
                    <i data-lucide="package"></i> Store Items
                </a>
                <a href="admin-orders.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition">
                    <i data-lucide="shopping-bag"></i> Orders
                </a>
                <a href="admin-staff.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition group">
                    <i data-lucide="users"></i> Staff Members
                </a>
                <a href="admin-settings.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition group">
                    <i data-lucide="settings"></i> System Settings
                </a>
            </nav>
            <div class="p-4 border-t border-emerald-800/50">
                <button id="logoutBtn" class="flex items-center gap-3 p-4 w-full rounded-2xl hover:bg-red-500 transition text-red-100 font-bold">
                    <i data-lucide="log-out"></i> Logout
                </button>
            </div>
        </aside>

        <main class="flex-1 lg:ml-64 p-4 lg:p-10">
            <header class="flex justify-between items-center mb-10">
                <div class="flex items-center gap-4">
                    <button class="lg:hidden p-2 bg-white rounded-xl shadow-sm border border-[#DCFCE7]" onclick="toggleSidebar()">
                        <i data-lucide="menu" class="text-[#059669]"></i>
                    </button>
                    <div class="flex flex-col">
                        <h2 class="text-2xl lg:text-3xl font-black text-[#064E3B]">Welfare Dashboard</h2>
                        <p class="text-[#059669] text-sm font-medium italic">Overview of PMM Welfare Shop activities</p>
                    </div>
                </div>
                <div class="text-right bg-white py-2 lg:py-3 px-4 lg:px-6 rounded-[1.5rem] shadow-sm border border-[#DCFCE7]">
                    <p class="font-black text-[#064E3B] text-sm lg:text-base" id="adminNameDisplay">admin12345</p>
                    <p class="text-[9px] lg:text-[10px] uppercase tracking-widest text-[#059669] font-bold italic">Main Administrator</p>
                </div>
            </header>

            <section class="space-y-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-[#DCFCE7]">
                        <p class="text-[#059669] text-[10px] font-black uppercase tracking-widest">Orders (Month)</p>
                        <h3 class="text-2xl font-black mt-1 text-[#064E3B]" id="stat-monthly-orders">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-[#DCFCE7]">
                        <p class="text-[#059669] text-[10px] font-black uppercase tracking-widest">Pending Orders</p>
                        <h3 class="text-2xl font-black mt-1 text-amber-600" id="stat-pending">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-[#DCFCE7]">
                        <p class="text-[#059669] text-[10px] font-black uppercase tracking-widest">Welfare Sales</p>
                        <h3 class="text-2xl font-black mt-1 text-[#064E3B]" id="stat-revenue">Rs. 0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-[#DCFCE7]">
                        <p class="text-[#059669] text-[10px] font-black uppercase tracking-widest">Total Savings</p>
                        <h3 class="text-2xl font-black mt-1 text-emerald-600" id="stat-savings">Rs. 0</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-[#DCFCE7]">
                        <p class="text-[#059669] text-[10px] font-black uppercase tracking-widest">Active Items</p>
                        <h3 class="text-2xl font-black mt-1 text-[#064E3B]" id="stat-active">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-red-100">
                        <p class="text-red-500 text-[10px] font-black uppercase tracking-widest">Inactive Items</p>
                        <h3 class="text-2xl font-black mt-1 text-red-600" id="stat-inactive">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-orange-100">
                        <p class="text-orange-500 text-[10px] font-black uppercase tracking-widest">Low Stock (< 5)</p>
                        <h3 class="text-2xl font-black mt-1 text-orange-600" id="stat-low-stock">0</h3>
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-red-200">
                        <p class="text-red-600 text-[10px] font-black uppercase tracking-widest">Out of Stock</p>
                        <h3 class="text-2xl font-black mt-1 text-red-700" id="stat-out-stock">0</h3>
                    </div>
                </div>

                <div class="bg-white p-6 lg:p-8 rounded-[3rem] shadow-sm border border-[#DCFCE7]">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-xl font-black text-[#064E3B]">Recent Order Activities</h3>
                        <a href="admin-orders.html" class="text-xs font-bold text-[#059669] underline">View All Orders</a>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-[600px]">
                            <thead>
                                <tr class="text-[#059669] text-[10px] uppercase tracking-widest border-b border-[#F0FDF4]">
                                    <th class="pb-4">Order ID</th>
                                    <th class="pb-4">Date</th>
                                    <th class="pb-4">Staff Member</th>
                                    <th class="pb-4">Product</th>
                                    <th class="pb-4">Status</th>
                                </tr>
                            </thead>
                            <tbody id="dashboardOrderTable" class="text-sm font-medium"></tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, limit, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3jlpc_vbUydda2XpDj5Xd1J8kVei9v8U",
            authDomain: "inventory-c3cca.firebaseapp.com",
            projectId: "inventory-c3cca",
            storageBucket: "inventory-c3cca.firebasestorage.app",
            messagingSenderId: "396140403894",
            appId: "1:396140403894:web:316617b8e390f8b0575a17"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Sidebar Toggle Logic
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('sidebar-open');
            overlay.classList.toggle('hidden');
        };

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === "admin") {
                    document.getElementById('adminNameDisplay').innerText = userDoc.data().name || "admin12345";
                    loadRealtimeDashboard();
                } else { window.location.href = "admin-login.html"; }
            } else { window.location.href = "admin-login.html"; }
        });

        function loadRealtimeDashboard() {
            // Stats Logic Fix: Handling "Rejected" items correctly 
            onSnapshot(collection(db, "orders"), (snap) => {
                let revenue = 0;
                let savings = 0;
                let pendingCount = 0;
                let monthlyCount = 0;
                const now = new Date();

                snap.forEach(d => {
                    const data = d.data();
                    const orderDate = data.createdAt?.toDate();
                    
                    if(data.status !== "Cancelled") {
                        data.items.forEach(item => {
                            const itemStatus = item.status || "Pending";

                            // Exclude REJECTED items from financials [cite: 44, 118]
                            if(itemStatus !== "Rejected") {
                                if(itemStatus === "Dispatched" || itemStatus === "Completed") {
                                    revenue += (item.welfarePrice * item.qty);
                                    savings += ((item.mrpPrice - item.welfarePrice) * item.qty);
                                }
                                if(itemStatus === "Pending") pendingCount++;
                            }
                        });

                        if(orderDate && orderDate.getMonth() === now.getMonth() && orderDate.getFullYear() === now.getFullYear()) {
                            monthlyCount++;
                        }
                    }
                });

                document.getElementById('stat-revenue').innerText = "Rs. " + revenue.toLocaleString();
                document.getElementById('stat-savings').innerText = "Rs. " + savings.toLocaleString();
                document.getElementById('stat-pending').innerText = pendingCount; 
                document.getElementById('stat-monthly-orders').innerText = monthlyCount;
            });

            // Inventory Stats Fix [cite: 30, 31, 36]
            onSnapshot(collection(db, "items"), (snap) => {
                let active = 0, inactive = 0, lowStock = 0, outStock = 0;
                snap.forEach(d => {
                    const item = d.data();
                    // Correcting Active/Inactive logic 
                    if(item.status === "Active" || item.status === "In Stock") active++; 
                    else inactive++;

                    if(item.stock <= 0) outStock++;
                    else if(item.stock < 5) lowStock++;
                });
                document.getElementById('stat-active').innerText = active;
                document.getElementById('stat-inactive').innerText = inactive;
                document.getElementById('stat-low-stock').innerText = lowStock;
                document.getElementById('stat-out-stock').innerText = outStock;
            });

            const qRecent = query(collection(db, "orders"), orderBy("createdAt", "desc"), limit(5));
            onSnapshot(qRecent, (snap) => {
                const table = document.getElementById('dashboardOrderTable');
                table.innerHTML = '';
                snap.forEach(d => {
                    const order = d.data();
                    const status = order.status || "Pending";
                    let statusClasses = status === "Completed" ? "text-emerald-600 bg-emerald-50" : "text-amber-600 bg-amber-50";
                    
                    // Unified Order Number 
                    const orderNoDisplay = order.orderNo || '#' + d.id.substring(0, 8); 

                    table.innerHTML += `
                        <tr class="border-b border-[#F0FDF4] hover:bg-[#F0FDF4]/50 transition">
                            <td class="py-5 font-black text-xs text-[#059669]">${orderNoDisplay}</td>
                            <td class="py-5 text-[11px] font-bold">${order.createdAt?.toDate().toLocaleDateString() || 'Today'}</td>
                            <td class="py-5">
                                <p class="font-black text-xs text-[#064E3B]">${order.staffName}</p>
                                <p class="text-[9px] text-[#059669] uppercase">${order.userPosition}</p>
                            </td>
                            <td class="py-5 text-xs font-semibold">
                                ${order.items && order.items.length > 0 ? order.items[0].name + (order.items.length > 1 ? '...' : '') : 'N/A'}
                            </td>
                            <td class="py-5">
                                <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase ${statusClasses}">${status}</span>
                            </td>
                        </tr>
                    `;
                });
                lucide.createIcons();
            });
        }

        // Logout Confirmation 
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if(confirm("Are you sure you want to exit the admin panel?")) {
                signOut(auth).then(() => window.location.href = "admin-login.html");
            }
        });
        
        lucide.createIcons();
    </script>
</body>
</html>