<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - PMM Welfare Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F0FDF4; }
        ::-webkit-scrollbar-thumb { background: #059669; border-radius: 10px; }
        .permission-card:has(input:checked) { border-color: #10b981; background-color: #ecfdf5; }
        
        /* Sidebar transition */
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-[#F0FDF4] text-[#064E3B] overflow-x-hidden">

    <!-- EDIT ADMIN PERMISSIONS MODAL -->
    <div id="editAdminModal" class="fixed inset-0 bg-[#064E3B]/70 hidden z-[200] flex items-center justify-center p-4" style="backdrop-filter:blur(8px);">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] p-6 md:p-8 shadow-2xl border border-white/20">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="text-xl font-black text-[#064E3B]">Edit Admin Permissions</h3>
                    <p class="text-xs text-emerald-500 font-bold" id="editAdminEmailLabel"></p>
                </div>
                <button onclick="closeEditAdminModal()" class="text-emerald-300 hover:text-red-500 transition">
                    <i data-lucide="x-circle" class="w-8 h-8"></i>
                </button>
            </div>
            <input type="hidden" id="editAdminUid">

            <label class="text-[11px] font-black uppercase ml-2 text-emerald-800 mb-4 block">Access Permissions:</label>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 mb-6">
                <label class="edit-perm-card border border-emerald-100 bg-[#F0FDF4] p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                    <input type="checkbox" id="ep_dashboard" class="hidden peer">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 text-emerald-600"></i>
                    <span class="text-[10px] font-black text-center uppercase">Dashboard</span>
                    <div class="w-4 h-4 rounded border-2 border-emerald-300 peer-checked:bg-emerald-500 peer-checked:border-emerald-500 transition"></div>
                </label>
                <label class="edit-perm-card border border-emerald-100 bg-[#F0FDF4] p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                    <input type="checkbox" id="ep_bincard" class="hidden peer">
                    <i data-lucide="clipboard-list" class="w-5 h-5 text-emerald-600"></i>
                    <span class="text-[10px] font-black text-center uppercase">Bin Card</span>
                    <div class="w-4 h-4 rounded border-2 border-emerald-300 peer-checked:bg-emerald-500 peer-checked:border-emerald-500 transition"></div>
                </label>
                <label class="edit-perm-card border border-emerald-100 bg-[#F0FDF4] p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                    <input type="checkbox" id="ep_items" class="hidden peer">
                    <i data-lucide="package" class="w-5 h-5 text-emerald-600"></i>
                    <span class="text-[10px] font-black text-center uppercase">Store Items</span>
                    <div class="w-4 h-4 rounded border-2 border-emerald-300 peer-checked:bg-emerald-500 peer-checked:border-emerald-500 transition"></div>
                </label>
                <label class="edit-perm-card border border-emerald-100 bg-[#F0FDF4] p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                    <input type="checkbox" id="ep_orders" class="hidden peer">
                    <i data-lucide="shopping-bag" class="w-5 h-5 text-emerald-600"></i>
                    <span class="text-[10px] font-black text-center uppercase">Orders</span>
                    <div class="w-4 h-4 rounded border-2 border-emerald-300 peer-checked:bg-emerald-500 peer-checked:border-emerald-500 transition"></div>
                </label>
                <label class="edit-perm-card border border-emerald-100 bg-[#F0FDF4] p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                    <input type="checkbox" id="ep_staff" class="hidden peer">
                    <i data-lucide="users" class="w-5 h-5 text-emerald-600"></i>
                    <span class="text-[10px] font-black text-center uppercase">Staff</span>
                    <div class="w-4 h-4 rounded border-2 border-emerald-300 peer-checked:bg-emerald-500 peer-checked:border-emerald-500 transition"></div>
                </label>
                <label class="edit-perm-card border border-emerald-100 bg-[#F0FDF4] p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md has-[:checked]:border-emerald-500 has-[:checked]:bg-emerald-50">
                    <input type="checkbox" id="ep_settings" class="hidden peer">
                    <i data-lucide="settings" class="w-5 h-5 text-emerald-600"></i>
                    <span class="text-[10px] font-black text-center uppercase">Settings</span>
                    <div class="w-4 h-4 rounded border-2 border-emerald-300 peer-checked:bg-emerald-500 peer-checked:border-emerald-500 transition"></div>
                </label>
            </div>

            <button id="saveAdminPermBtn" onclick="saveAdminPermissions()" class="w-full bg-[#059669] text-white p-5 rounded-3xl font-black hover:bg-[#047857] transition shadow-xl flex justify-center items-center gap-2">
                <span id="savePermBtnText">Save Permissions</span>
                <div id="savePermLoader" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            </button>
        </div>
    </div>

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden backdrop-blur-sm"></div>

    <div class="flex min-h-screen relative">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-[#064E3B] text-white sidebar-transition transform -translate-x-full lg:translate-x-0 shadow-2xl overflow-y-auto">
            <div class="p-8 border-b border-emerald-800/50 flex justify-between items-center">
                <h1 class="text-2xl font-black italic flex items-center gap-2">
                    <i data-lucide="box"></i> PMM Welfare.
                </h1>
                <button onclick="toggleSidebar()" class="lg:hidden text-white/50 hover:text-white">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <nav class="mt-6 px-4 space-y-2">
                <a href="admin.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition"><i data-lucide="layout-dashboard"></i> Dashboard</a>
                <a href="admin-bin-card.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition"><i data-lucide="clipboard-list"></i> Bin Card</a>
                <a href="admin-items.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition"><i data-lucide="package"></i> Store Items</a>
                <a href="admin-orders.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition"><i data-lucide="shopping-bag"></i> Orders</a>
                <a href="admin-staff.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition"><i data-lucide="users"></i> Staff Members</a>
                <a href="admin-settings.html" class="flex items-center gap-3 p-4 rounded-2xl bg-emerald-600/30 border border-emerald-500/30 transition"><i data-lucide="settings"></i> System Settings</a>
                <div class="pt-20 pb-10">
                    <button id="logoutBtn" class="flex items-center gap-3 p-4 w-full rounded-2xl hover:bg-red-500 transition text-red-100"><i data-lucide="log-out"></i> Logout</button>
                </div>
            </nav>
        </aside>

        <main class="flex-1 lg:ml-72 p-4 md:p-8 lg:p-10 w-full">
            <header class="mb-10 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden p-3 bg-white rounded-2xl shadow-sm border border-emerald-100 text-[#059669]">
                        <i data-lucide="menu"></i>
                    </button>
                    <div>
                        <h2 class="text-2xl md:text-3xl font-black text-[#064E3B]">System Settings</h2>
                        <p class="text-[#059669] text-sm font-medium italic">Store identity, banners and permissions</p>
                    </div>
                </div>
            </header>

            <div class="bg-red-50 p-6 rounded-[2.5rem] border-2 border-red-100 mb-8">
    <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
        <div>
            <h4 class="font-black text-red-700 uppercase text-sm flex items-center gap-2">
                <i data-lucide="alert-triangle"></i> Emergency Maintenance Mode
            </h4>
            <p class="text-[10px] text-red-500 font-bold italic mt-1">
               
            </p>
        </div>
        <div class="flex flex-col items-center gap-2 flex-shrink-0">
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="maintenanceToggle" class="sr-only peer">
                <div class="w-14 h-7 bg-gray-300 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-red-600"></div>
            </label>
            <span id="maintenanceStatusLabel" class="text-[9px] font-black uppercase tracking-widest text-gray-400">Loading...</span>
        </div>
    </div>
</div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 md:p-8 rounded-[2.5rem] shadow-sm border border-[#DCFCE7]">
                    <h3 class="text-xl font-black mb-6 flex items-center gap-2 text-[#064E3B]"><i data-lucide="globe"></i> Store Identity</h3>
                    <div class="space-y-6">
                        <div class="flex flex-col sm:flex-row items-center gap-4">
                            <img id="logoPreview" src="https://placehold.co/100x100?text=Logo" class="w-20 h-20 rounded-2xl border-2 border-emerald-50 object-contain bg-gray-50 p-2 shadow-inner">
                            <div class="flex-1 w-full">
                                <label class="text-[10px] font-bold text-[#059669] uppercase tracking-widest block ml-2 mb-1">Update Company Logo</label>
                                <input type="file" id="logoInput" accept="image/*" class="text-xs w-full p-2 bg-emerald-50 rounded-xl">
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-bold text-[#059669] uppercase ml-2 tracking-widest">Store Display Name</label>
                            <input type="text" id="siteNameInput" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold focus:outline-emerald-500 mt-1">
                        </div>
                        <button id="saveIdentityBtn" class="bg-[#059669] text-white px-8 py-4 rounded-2xl font-black hover:bg-[#047857] transition shadow-lg w-full">Update Identity</button>
                    </div>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-[2.5rem] shadow-sm border border-[#DCFCE7]">
                    <h3 class="text-xl font-black mb-6 flex items-center gap-2 text-[#064E3B]"><i data-lucide="map-pin"></i> Office Locations</h3>
                    <div class="space-y-4">
                        <div class="flex flex-col sm:flex-row gap-2">
                            <input type="text" id="newLocInput" placeholder="Ex: Colombo Head Office" class="flex-1 p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold focus:outline-emerald-500">
                            <button id="addLocBtn" class="bg-[#059669] text-white px-6 py-4 rounded-2xl font-black hover:bg-[#047857]">Add</button>
                        </div>
                        <div id="locList" class="flex flex-wrap gap-2 mt-4"></div>
                    </div>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-[3rem] shadow-sm border border-[#DCFCE7] lg:col-span-2">
                    <h3 class="text-xl font-black mb-6 flex items-center gap-2 text-[#064E3B]">
                        <i data-lucide="image" class="text-[#059669]"></i> Role-Specific Banners
                    </h3>
                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                        <div>
                            <label class="text-[10px] font-bold text-[#059669] uppercase ml-2 tracking-widest">Select User Role</label>
                            <select id="bannerRoleSelect" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold mb-4 focus:outline-emerald-500"></select>
                            <p class="text-[10px] text-gray-400 italic px-2">Select a specific role to customize the store banner they see.</p>
                        </div>
                        <div class="xl:col-span-2 space-y-4 p-4 md:p-6 bg-[#F0FDF4] rounded-3xl border border-[#DCFCE7]">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="bannerTitle" placeholder="Banner Heading Text" class="p-4 rounded-xl border border-[#DCFCE7] font-bold text-sm">
                                <input type="text" id="bannerSub" placeholder="Banner Sub-text" class="p-4 rounded-xl border border-[#DCFCE7] font-bold text-sm">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="bg-white p-3 rounded-xl border border-emerald-100">
                                    <label class="text-[9px] font-black uppercase ml-1 block mb-1">Desktop Image (1200x400)</label>
                                    <input type="file" id="deskImg" class="w-full text-xs">
                                </div>
                                <div class="bg-white p-3 rounded-xl border border-emerald-100">
                                    <label class="text-[9px] font-black uppercase ml-1 block mb-1">Mobile Image (600x800)</label>
                                    <input type="file" id="mobImg" class="w-full text-xs">
                                </div>
                            </div>
                            <button id="saveBannerBtn" class="w-full bg-[#059669] text-white p-4 rounded-2xl font-black shadow-xl flex justify-center items-center gap-2 hover:bg-[#047857] transition">
                                <span id="bannerBtnText">Update Banner</span>
                                <div id="bannerLoader" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <div id="superAdminSection" class="hidden lg:col-span-2 bg-white p-6 md:p-8 rounded-[3rem] shadow-sm border-2 border-emerald-100">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                        <h3 class="text-xl font-black text-[#064E3B] flex items-center gap-2">
                            <i data-lucide="shield-check" class="text-emerald-600"></i> Admin Access & Permissions
                        </h3>
                        <button onclick="toggleAdminForm()" class="w-full sm:w-auto bg-emerald-600 text-white px-6 py-3 rounded-2xl text-xs font-black shadow-lg hover:bg-emerald-700 transition">Add New Admin</button>
                    </div>

                    <div id="adminForm" class="hidden mb-10 p-4 md:p-8 bg-[#F0FDF4] rounded-[2.5rem] border border-[#DCFCE7]">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="text-[10px] font-black uppercase ml-2 text-emerald-700">Admin Name</label>
                                <input type="text" id="newAdminName" placeholder="Full Name" class="w-full p-4 rounded-2xl border border-[#DCFCE7] font-bold focus:outline-emerald-500 bg-white">
                            </div>
                            <div>
                                <label class="text-[10px] font-black uppercase ml-2 text-emerald-700">Email Address</label>
                                <input type="email" id="newAdminEmail" placeholder="email@example.com" class="w-full p-4 rounded-2xl border border-[#DCFCE7] font-bold focus:outline-emerald-500 bg-white">
                            </div>
                            <div>
                                <label class="text-[10px] font-black uppercase ml-2 text-emerald-700">Temp Password</label>
                                <input type="password" id="newAdminPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full p-4 rounded-2xl border border-[#DCFCE7] font-bold focus:outline-emerald-500 bg-white">
                            </div>
                        </div>

                        <label class="text-[11px] font-black uppercase ml-2 text-emerald-800 mb-4 block underline">Assign Access Permissions:</label>
                        <div class="grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-6 gap-3 mb-8">
                            <label class="permission-card border border-emerald-100 bg-white p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md">
                                <input type="checkbox" id="p_dashboard" class="hidden peer" checked>
                                <i data-lucide="layout-dashboard" class="w-5 h-5 text-emerald-600"></i>
                                <span class="text-[10px] font-black text-center uppercase">Dashboard</span>
                            </label>
                            <label class="permission-card border border-emerald-100 bg-white p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md">
                                <input type="checkbox" id="p_bincard" class="hidden peer">
                                <i data-lucide="clipboard-list" class="w-5 h-5 text-emerald-600"></i>
                                <span class="text-[10px] font-black text-center uppercase">Bin Card</span>
                            </label>
                            <label class="permission-card border border-emerald-100 bg-white p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md">
                                <input type="checkbox" id="p_items" class="hidden peer">
                                <i data-lucide="package" class="w-5 h-5 text-emerald-600"></i>
                                <span class="text-[10px] font-black text-center uppercase">Store Items</span>
                            </label>
                            <label class="permission-card border border-emerald-100 bg-white p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md">
                                <input type="checkbox" id="p_orders" class="hidden peer">
                                <i data-lucide="shopping-bag" class="w-5 h-5 text-emerald-600"></i>
                                <span class="text-[10px] font-black text-center uppercase">Orders</span>
                            </label>
                            <label class="permission-card border border-emerald-100 bg-white p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md">
                                <input type="checkbox" id="p_staff" class="hidden peer">
                                <i data-lucide="users" class="w-5 h-5 text-emerald-600"></i>
                                <span class="text-[10px] font-black text-center uppercase">Staff</span>
                            </label>
                            <label class="permission-card border border-emerald-100 bg-white p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md">
                                <input type="checkbox" id="p_settings" class="hidden peer">
                                <i data-lucide="settings" class="w-5 h-5 text-emerald-600"></i>
                                <span class="text-[10px] font-black text-center uppercase">Settings</span>
                            </label>

                                <label class="permission-card border border-red-100 bg-white p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md">
                                    <input type="checkbox" id="p_clear_orders" class="hidden peer">
                                    <i data-lucide="trash-2" class="w-5 h-5 text-red-600"></i>
                                    <span class="text-[10px] font-black text-center uppercase">Clear Orders</span>
                                </label>

                                <label class="permission-card border border-red-100 bg-white p-4 rounded-2xl flex flex-col items-center gap-2 cursor-pointer transition-all hover:shadow-md">
                                    <input type="checkbox" id="p_clear_bin" class="hidden peer">
                                    <i data-lucide="eraser" class="w-5 h-5 text-red-600"></i>
                                    <span class="text-[10px] font-black text-center uppercase">Clear Bin Logs</span>
                                </label>

                        </div>

                        <button id="createAdminBtn" class="w-full sm:w-auto bg-[#064E3B] text-white px-10 py-4 rounded-2xl font-black shadow-xl hover:bg-black transition flex items-center justify-center gap-2">
                            Create Admin Account <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6" id="adminList"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, collection, onSnapshot, addDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3jlpc_vbUydda2XpDj5Xd1J8kVei9v8U",
            authDomain: "inventory-c3cca.firebaseapp.com",
            projectId: "inventory-c3cca",
            storageBucket: "inventory-c3cca.firebasestorage.app",
            messagingSenderId: "396140403894",
            appId: "1:396140403894:web:316617b8e390f8b0575a17"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const mToggle = document.getElementById('maintenanceToggle');

        // --- MAINTENANCE TOGGLE ---
        // 1. DB à¶½à·™à·€à¶½à·Š toggle state load à¶šà·’à¶»à·“à¶¸ (SuperAdmin only à¶§ à¶´à·™à¶±à·™à¶±à·€à·)
        onSnapshot(doc(db, "settings", "site"), (snap) => {
            if (snap.exists()) {
                const isOn = snap.data().isMaintenanceMode || false;
                mToggle.checked = isOn;
                const label = document.getElementById('maintenanceStatusLabel');
                if (label) {
                    label.innerText = isOn ? 'ðŸ”´ Store Closed' : 'ðŸŸ¢ Store Open';
                    label.className = isOn
                        ? 'text-[9px] font-black uppercase tracking-widest text-red-600'
                        : 'text-[9px] font-black uppercase tracking-widest text-emerald-600';
                }
            }
        });

        // 2. Toggle change à·€à·– à·€à·’à¶§ DB update à¶šà·’à¶»à·“à¶¸
        mToggle.addEventListener('change', async () => {
            const status = mToggle.checked;
            const msg = status
                ? "âš ï¸ Maintenance Mode ON à¶šà¶»à·à¶¸ à·ƒà·’à¶ºà¶½à·” Staff à¶§ store access à¶±à·à¶­à·’ à·€à·™à¶ºà·’. Continue à¶šà¶»à¶±à·Šà¶±à¶¯?"
                : "âœ… Maintenance Mode OFF à¶šà¶»à·à¶¸ Store à¶±à·à·€à¶­ Open à·€à·™à¶ºà·’. Continue à¶šà¶»à¶±à·Šà¶±à¶¯?";

            if (confirm(msg)) {
                try {
                    await updateDoc(doc(db, "settings", "site"), { isMaintenanceMode: status });
                    alert(`Store is now ${status ? 'ðŸ”´ SHUT DOWN for maintenance' : 'ðŸŸ¢ OPEN for staff'}`);
                } catch (e) {
                    alert("Error: " + e.message);
                    mToggle.checked = !status;
                }
            } else {
                mToggle.checked = !status;
            }
        });

        // Sidebar Control
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                document.body.classList.add('overflow-hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }
        };

      onAuthStateChanged(auth, async (user) => {
    if (user) {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const data = userDoc.data();

        if (data.role === "admin") {
            // 1. à¶´à·’à¶§à·”à·€à¶§ à¶‡à¶­à·”à·…à·” à·€à·“à¶¸à¶§ à¶…à·€à·ƒà¶» à¶­à·’à¶¶à·šà¶¯à·à¶ºà·’ à¶´à¶»à·“à¶šà·Šà·‚à· à¶šà·’à¶»à·“à¶¸ (Access Guard)
            const hasAccess = data.isSuperAdmin || data.email === "admin@inventory.com" || (data.permissions && data.permissions.settings);

            if (!hasAccess) {
                alert("à·ƒà¶¸à·à·€à¶±à·Šà¶±! à¶”à¶¶à¶§ à¶¸à·™à¶¸ à¶´à·’à¶§à·”à·€à¶§ (Settings) à¶´à·’à·€à·’à·ƒà·“à¶¸à¶§ à¶…à·€à·ƒà¶» à¶±à·à¶­.");
                window.location.href = "admin.html"; // à¶…à·€à·ƒà¶» à¶±à·à¶­à·Šà¶±à¶¸à·Š Dashboard à¶‘à¶šà¶§ à·„à¶»à·€à· à¶ºà·à·€à·“à¶¸
                return;
            }

            // 2. Super Admin à¶§ à¶´à¶¸à¶«à¶šà·Š à¶´à·™à¶±à·™à¶± à¶šà·œà¶§à·ƒ (Admin Creation Form)
            if (data.isSuperAdmin || data.email === "admin@inventory.com") {
                document.getElementById('superAdminSection').classList.remove('hidden');
                loadAdmins();
            }
            
            loadSettings(); // à¶´à¶»à·Šà¶¸à·’à·‚à¶±à·Š à¶­à·’à¶ºà·™à¶±à·€à· à¶±à¶¸à·Š à·€à·’à¶­à¶»à¶šà·Š à·ƒà·™à¶§à·’à¶±à·Šà¶œà·Šà·ƒà·Š à¶½à·à¶©à·Š à¶šà·’à¶»à·“à¶¸
        } else { 
            window.location.href = "admin-login.html"; 
        }
    } else { 
        window.location.href = "admin-login.html"; 
    }
});

        async function loadSettings() {
            const siteSnap = await getDoc(doc(db, "settings", "site"));
            if(siteSnap.exists()) {
                document.getElementById('siteNameInput').value = siteSnap.data().name || "";
                document.getElementById('logoPreview').src = siteSnap.data().logoUrl || "https://placehold.co/100x100?text=Logo";
            }

            onSnapshot(collection(db, "roles"), (snap) => {
                const select = document.getElementById('bannerRoleSelect');
                select.innerHTML = '<option value="" disabled selected>Select Role</option>';
                snap.forEach(d => select.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`);
            });

            onSnapshot(collection(db, "locations"), (snap) => {
                const list = document.getElementById('locList');
                list.innerHTML = '';
                snap.forEach(d => {
                    list.innerHTML += `<span class="bg-emerald-100 text-emerald-700 px-4 py-2 rounded-full text-xs font-black flex items-center gap-2">${d.data().name} <button onclick="deleteLocation('${d.id}')" class="hover:text-red-500"><i data-lucide="x" class="w-3 h-3"></i></button></span>`;
                });
                lucide.createIcons();
            });
        }

        document.getElementById('saveIdentityBtn').addEventListener('click', async () => {
            const name = document.getElementById('siteNameInput').value;
            const logoFile = document.getElementById('logoInput').files[0];
            let logoUrl = document.getElementById('logoPreview').src;

            if(logoFile) {
                const fd = new FormData(); fd.append('image', logoFile);
                const res = await fetch('https://api.imgbb.com/1/upload?key=fb6365d6c7a493fa14ff7596b4e39e07', { method: 'POST', body: fd });
                const json = await res.json(); logoUrl = json.data.display_url;
            }

            await setDoc(doc(db, "settings", "site"), { name, logoUrl }, { merge: true });
            alert("Identity Updated Successfully!");
            location.reload();
        });

        document.getElementById('saveBannerBtn').addEventListener('click', async () => {
            const role = document.getElementById('bannerRoleSelect').value;
            if(!role) return alert("Please select a role first!");
            
            const btn = document.getElementById('bannerBtnText');
            const loader = document.getElementById('bannerLoader');
            btn.innerText = "Processing..."; loader.classList.remove('hidden');

            try {
                let deskUrl = "", mobUrl = "";
                const deskF = document.getElementById('deskImg').files[0];
                const mobF = document.getElementById('mobImg').files[0];

                if(deskF) {
                    const fd = new FormData(); fd.append('image', deskF);
                    const res = await fetch('https://api.imgbb.com/1/upload?key=fb6365d6c7a493fa14ff7596b4e39e07', { method: 'POST', body: fd });
                    const j = await res.json(); deskUrl = j.data.display_url;
                }
                if(mobF) {
                    const fd = new FormData(); fd.append('image', mobF);
                    const res = await fetch('https://api.imgbb.com/1/upload?key=fb6365d6c7a493fa14ff7596b4e39e07', { method: 'POST', body: fd });
                    const j = await res.json(); mobUrl = j.data.display_url;
                }

                const updateData = {
                    title: document.getElementById('bannerTitle').value,
                    subtitle: document.getElementById('bannerSub').value,
                    role: role,
                    updatedAt: new Date()
                };
                if(deskUrl) updateData.desktopUrl = deskUrl;
                if(mobUrl) updateData.mobileUrl = mobUrl;

                await setDoc(doc(db, "settings", `banner_${role}`), updateData, { merge: true });
                alert(`Banner successfully updated for ${role}!`);
            } catch (e) { alert(e.message); }
            finally { btn.innerText = "Update Banner"; loader.classList.add('hidden'); }
        });

        window.toggleAdminForm = () => document.getElementById('adminForm').classList.toggle('hidden');

        document.getElementById('createAdminBtn').addEventListener('click', async () => {
            const name = document.getElementById('newAdminName').value;
            const email = document.getElementById('newAdminEmail').value;
            const pass = document.getElementById('newAdminPass').value;

            if(!name || !email || !pass) return alert("All fields are required!");

          const perms = {
                dashboard: document.getElementById('p_dashboard').checked,
                binCard: document.getElementById('p_bincard').checked,
                items: document.getElementById('p_items').checked,
                orders: document.getElementById('p_orders').checked,
                staff: document.getElementById('p_staff').checked,
                settings: document.getElementById('p_settings').checked,
                canClearOrders: document.getElementById('p_clear_orders').checked,
                canClearBinLogs: document.getElementById('p_clear_bin').checked
            };

            const secondaryApp = initializeApp(firebaseConfig, "AdminCreator");
            const secondaryAuth = getAuth(secondaryApp);

            try {
                const cred = await createUserWithEmailAndPassword(secondaryAuth, email, pass);
                await setDoc(doc(db, "users", cred.user.uid), {
                    name, email, role: "admin", isSuperAdmin: false, status: "Active", permissions: perms, createdAt: new Date()
                });
                await signOut(secondaryAuth); await deleteApp(secondaryApp);
                alert("New Admin Created with Permissions!");
                toggleAdminForm();
            } catch (e) { alert(e.message); }
        });

        function loadAdmins() {
            onSnapshot(query(collection(db, "users"), where("role", "==", "admin")), (snap) => {
                const list = document.getElementById('adminList');
                list.innerHTML = '';
                snap.forEach(d => {
                    const adm = d.data();
                    if(adm.email === auth.currentUser.email) return;

                    let permBadges = "";
                    if(adm.permissions) {
                        Object.entries(adm.permissions).forEach(([key, val]) => {
                            if(val) permBadges += `<span class="bg-white text-[7px] border px-1 rounded uppercase font-black mr-1">${key}</span>`;
                        });
                    }

                    list.innerHTML += `
                        <div class="p-6 bg-[#F0FDF4] rounded-3xl border border-[#DCFCE7] shadow-sm flex flex-col justify-between">
                            <div>
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-black text-sm text-[#064E3B]">${adm.name}</h4>
                                    <span class="px-2 py-0.5 rounded-full text-[8px] font-black uppercase ${adm.status === 'Active' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">${adm.status}</span>
                                </div>
                                <p class="text-[10px] text-[#059669] mb-4">${adm.email}</p>
                                <div class="mb-4">
                                    <p class="text-[8px] uppercase font-bold text-gray-400 mb-1">Access Pages:</p>
                                    <div class="flex flex-wrap gap-y-1">${permBadges || '<span class="text-[8px] text-red-400">No Access</span>'}</div>
                                </div>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button onclick="openEditAdminModal('${d.id}', ${JSON.stringify(adm.permissions || {}).replace(/"/g, '&quot;')}, '${adm.email}')" class="flex-1 bg-emerald-600 text-white text-[10px] font-black py-2 rounded-xl hover:bg-emerald-700 transition flex items-center justify-center gap-1"><i data-lucide="pencil" class="w-3 h-3"></i> Edit Access</button>
                                <button onclick="updateAdminStatus('${d.id}', '${adm.status === 'Active' ? 'Inactive' : 'Active'}')" class="flex-1 bg-white text-[10px] font-black py-2 rounded-xl border border-emerald-100 hover:bg-emerald-50 transition">Status</button>
                                <button onclick="deleteAdmin('${d.id}')" class="p-2 text-red-400 hover:bg-red-50 rounded-xl transition"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>`;
                });
                lucide.createIcons();
            });
        }

        window.updateAdminStatus = async (uid, newStatus) => { await updateDoc(doc(db, "users", uid), { status: newStatus }); };
        window.deleteAdmin = async (uid) => { if(confirm("Permanently remove this admin account?")) await deleteDoc(doc(db, "users", uid)); };
        window.deleteLocation = async (id) => { if(confirm("Delete this location?")) await deleteDoc(doc(db, "locations", id)); };
        
        document.getElementById('addLocBtn').addEventListener('click', async () => {
            const name = document.getElementById('newLocInput').value;
            if(!name) return;
            await addDoc(collection(db, "locations"), { name });
            document.getElementById('newLocInput').value = '';
        });

        window.openEditAdminModal = (uid, permsJson, email) => {
            // permsJson may come as a string (from HTML attr) or object
            let perms = {};
            try { perms = typeof permsJson === 'string' ? JSON.parse(permsJson.replace(/&quot;/g, '"')) : permsJson; } catch(e) {}
            document.getElementById('editAdminUid').value = uid;
            document.getElementById('editAdminEmailLabel').innerText = email;
            document.getElementById('ep_dashboard').checked = !!perms.dashboard;
            document.getElementById('ep_bincard').checked = !!perms.binCard;
            document.getElementById('ep_items').checked = !!perms.items;
            document.getElementById('ep_orders').checked = !!perms.orders;
            document.getElementById('ep_staff').checked = !!perms.staff;
            document.getElementById('ep_settings').checked = !!perms.settings;
            document.getElementById('editAdminModal').classList.remove('hidden');
            lucide.createIcons();
        };

        window.closeEditAdminModal = () => document.getElementById('editAdminModal').classList.add('hidden');

        window.saveAdminPermissions = async () => {
            const uid = document.getElementById('editAdminUid').value;
            const btn = document.getElementById('savePermBtnText');
            const loader = document.getElementById('savePermLoader');
            btn.innerText = "Saving..."; loader.classList.remove('hidden');
            try {
                const perms = {
                    dashboard: document.getElementById('ep_dashboard').checked,
                    binCard:   document.getElementById('ep_bincard').checked,
                    items:     document.getElementById('ep_items').checked,
                    orders:    document.getElementById('ep_orders').checked,
                    staff:     document.getElementById('ep_staff').checked,
                    settings:  document.getElementById('ep_settings').checked
                };
                await updateDoc(doc(db, "users", uid), { permissions: perms });
                alert("Permissions updated successfully!");
                closeEditAdminModal();
            } catch(e) { alert("Error: " + e.message); }
            finally { btn.innerText = "Save Permissions"; loader.classList.add('hidden'); }
        };

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth).then(() => window.location.href = "admin-login.html"));
        lucide.createIcons();
    </script>
</body>
</html>