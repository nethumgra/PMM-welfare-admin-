<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - PMM Welfare Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F0FDF4; }
        ::-webkit-scrollbar-thumb { background: #059669; border-radius: 10px; }
    </style>
</head>
<body class="bg-[#F0FDF4] text-[#064E3B] font-sans">

    <div class="flex min-h-screen">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-[#064E3B] text-white transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out shadow-2xl">
            <div class="p-8 border-b border-emerald-800/50">
                <h1 class="text-2xl font-black italic flex items-center justify-center gap-2">
                    <i data-lucide="box"></i> PMM Welfare.
                </h1>
            </div>
            <nav class="mt-6 px-4 space-y-2">
                <a href="admin.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition">
                    <i data-lucide="layout-dashboard"></i> Dashboard
                </a>
                <a href="admin-bin-card.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition">
                    <i data-lucide="clipboard-list"></i> Bin Card
                </a>
                <a href="admin-items.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition">
                    <i data-lucide="package"></i> Store Items
                </a>
                <a href="admin-orders.html" class="flex items-center gap-3 p-4 rounded-2xl bg-emerald-600/30 border border-emerald-500/30 transition">
                    <i data-lucide="shopping-bag"></i> Orders
                </a>
                <a href="admin-staff.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition group">
                    <i data-lucide="users"></i> Staff Members
                </a>
                <div class="pt-20">
                    <button id="logoutBtn" class="flex items-center gap-3 p-4 w-full rounded-2xl hover:bg-red-500 transition text-red-100">
                        <i data-lucide="log-out"></i> Logout
                    </button>
                </div>
            </nav>
        </aside>

        <main class="flex-1 lg:ml-64 p-4 lg:p-10">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-black text-[#064E3B]">Order Management</h2>
                    <p class="text-[#059669] font-medium italic">Track lifecycle from Pending to Completed</p>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="exportPurchaseReport()" class="bg-blue-50 text-blue-600 px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase hover:bg-blue-600 hover:text-white transition border border-blue-100 flex items-center gap-2">
                        <i data-lucide="shopping-cart" class="w-4 h-4"></i> Purchase Report
                    </button>
                    
                    <button onclick="clearAllOrders()" class="bg-red-50 text-red-600 px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase hover:bg-red-600 hover:text-white transition border border-red-100 flex items-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Clear History
                    </button>
                    
                    <div class="bg-white py-2 px-6 rounded-2xl shadow-sm border border-[#DCFCE7] text-right">
                        <p class="font-black text-[#064E3B]" id="adminNameDisplay">Admin</p>
                        <p class="text-[10px] uppercase tracking-widest text-[#059669] font-bold">Main Admin</p>
                    </div>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-[2.5rem] border border-[#DCFCE7] shadow-sm flex items-center gap-6">
                    <div class="bg-emerald-100 p-4 rounded-3xl text-emerald-600"><i data-lucide="trending-up"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-[#059669] uppercase tracking-widest">Total Staff Savings</p>
                        <p class="text-2xl font-black text-emerald-600" id="totalSavingsDisplay">Rs. 0.00</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-[2.5rem] border border-[#DCFCE7] shadow-sm flex items-center gap-6">
                    <div class="bg-emerald-50 p-4 rounded-3xl text-[#064E3B]"><i data-lucide="shopping-cart"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-[#059669] uppercase tracking-widest">Total Welfare Sales</p>
                        <p class="text-2xl font-black text-[#064E3B]" id="totalRevenueDisplay">Rs. 0.00</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-4 mb-8">
                <div class="relative flex-1 min-w-[300px]">
                    <input type="text" id="orderSearchInput" oninput="loadOrders()" placeholder="Search Order No or Staff Name..." 
                        class="w-full bg-white border border-[#DCFCE7] text-[#064E3B] text-sm font-bold py-4 px-12 rounded-full focus:outline-none focus:ring-2 focus:ring-[#059669] shadow-sm">
                    <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-[#059669] w-5 h-5"></i>
                </div>

                <div class="bg-white p-2 rounded-[2rem] shadow-sm border border-[#DCFCE7] flex gap-1 overflow-x-auto w-fit">
                    <button onclick="setStatusFilter('all')" id="tab-all" class="tab-btn px-6 py-3 rounded-full text-[10px] font-black uppercase transition tab-active">All</button>
                    <button onclick="setStatusFilter('Pending')" id="tab-Pending" class="tab-btn px-6 py-3 rounded-full text-[10px] font-black uppercase transition text-[#059669] hover:bg-[#F0FDF4]">Pending</button>
                    <button onclick="setStatusFilter('Dispatched')" id="tab-Dispatched" class="tab-btn px-6 py-3 rounded-full text-[10px] font-black uppercase transition text-[#059669] hover:bg-[#F0FDF4]">Dispatched</button>
                </div>

                <div class="relative min-w-[180px]">
                  <select id="positionFilter" onchange="setPositionFilter(this.value)" 
                        class="w-full bg-white border border-[#DCFCE7] text-[#064E3B] text-[10px] font-black uppercase py-4 px-6 rounded-full appearance-none focus:outline-none focus:ring-2 focus:ring-[#059669] shadow-sm cursor-pointer">
                        <option value="all">All Positions</option>
                  </select>
                  <i data-lucide="chevron-down" class="absolute right-5 top-1/2 -translate-y-1/2 text-[#059669] w-4 h-4 pointer-events-none"></i>
                </div>
            </div>

            <div class="bg-white rounded-[3rem] shadow-sm border border-[#DCFCE7] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-[#F0FDF4] text-[#059669] text-[10px] uppercase tracking-widest border-b border-[#DCFCE7]">
                                <th class="p-6">Order No & Items</th>
                                <th class="p-6">Staff Member</th>
                                <th class="p-6 text-center">Status</th>
                                <th class="p-6">Financials</th>
                                <th class="p-6 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody" class="text-sm font-medium text-[#064E3B]"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, doc, getDoc, orderBy, updateDoc, deleteDoc, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3jlpc_vbUydda2XpDj5Xd1J8kVei9v8U",
            authDomain: "inventory-c3cca.firebaseapp.com",
            projectId: "inventory-c3cca",
            storageBucket: "inventory-c3cca.firebasestorage.app",
            messagingSenderId: "396140403894",
            appId: "1:396140403894:web:316617b8e390f8b0575a17"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentStatusFilter = 'all';
        let currentPositionFilter = 'all';
        let unsubscribeOrders = null;
        let currentAdminName = "Admin";

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === "admin") {
                    currentAdminName = userDoc.data().name;
                    document.getElementById('adminNameDisplay').innerText = currentAdminName;
                    loadOrders();
                } else { window.location.href = "admin-login.html"; }
            } else { window.location.href = "admin-login.html"; }
        });

        window.loadOrders = () => {
            const tableBody = document.getElementById('ordersTableBody');
            const searchTerm = document.getElementById('orderSearchInput').value.toLowerCase().trim();
            if (unsubscribeOrders) unsubscribeOrders();

            let constraints = [];
            if (currentStatusFilter !== 'all') constraints.push(where("status", "==", currentStatusFilter));
            if (currentPositionFilter !== 'all') constraints.push(where("userPosition", "==", currentPositionFilter));
            constraints.push(orderBy("createdAt", "desc"));

            const q = query(collection(db, "orders"), ...constraints);

            unsubscribeOrders = onSnapshot(q, (snap) => {
                tableBody.innerHTML = '';
                let totalRev = 0; let totalSave = 0;

                snap.forEach(d => {
                    const order = d.data();
                    const id = d.id;
                    const orderNo = order.orderNo || id.substring(0, 8).toUpperCase();
                    const staffName = order.staffName || "Unknown Staff";
                    
                    if (searchTerm && !orderNo.toLowerCase().includes(searchTerm) && !staffName.toLowerCase().includes(searchTerm)) return;

                    if(order.status !== "Cancelled") {
                        (order.items || []).forEach(item => {
                            if(item.status === "Dispatched" || item.status === "Completed") {
                                totalRev += (item.welfarePrice * item.qty);
                                totalSave += ((item.mrpPrice - item.welfarePrice) * item.qty);
                            }
                        });
                    }

                    let statusClass = "bg-amber-100 text-amber-600";
                    if(order.status === "Dispatched") statusClass = "bg-blue-100 text-blue-600";
                    if(order.status === "Completed") statusClass = "bg-emerald-100 text-emerald-600";

                    let itemsHtml = (order.items || []).map((item, index) => `
                        <div class="flex justify-between items-center p-3 border-b border-emerald-50 last:border-0 bg-white">
                            <div class="flex items-center gap-3">
                                <span class="w-2 h-2 rounded-full ${item.status === 'Dispatched' ? 'bg-blue-500' : 'bg-amber-500'}"></span>
                                <div>
                                    <p class="font-bold text-[11px]">${item.name} (x${item.qty})</p>
                                    <p class="text-[9px] font-black uppercase text-gray-400">${item.status || 'Pending'}</p>
                                </div>
                            </div>
                            ${(item.status !== 'Dispatched' && order.status !== 'Cancelled') ? `
                                <button onclick="dispatchIndividualItem('${id}', ${index})" class="text-[9px] bg-emerald-600 text-white px-3 py-1 rounded-lg font-black hover:bg-emerald-700 transition uppercase">Dispatch</button>
                            ` : (item.status === 'Dispatched' ? '<i data-lucide="check-circle" class="w-4 h-4 text-blue-500"></i>' : '')}
                        </div>`).join('');

                    tableBody.innerHTML += `
                    <tr class="border-b border-[#F0FDF4] hover:bg-[#F0FDF4]/50 transition">
                        <td class="p-6">
                            <p class="font-black text-[#064E3B] text-lg tracking-tight">${orderNo}</p> 
                            <details class="mt-3 group cursor-pointer">
                                <summary class="list-none outline-none flex items-center gap-2 text-[#059669] text-[10px] font-black uppercase underline decoration-dotted">
                                    <i data-lucide="chevron-right" class="w-3 h-3 group-open:rotate-90 transition"></i> 
                                    View ${order.items ? order.items.length : 0} Items
                                </summary>
                                <div class="mt-3 border border-emerald-100 rounded-2xl overflow-hidden shadow-inner">${itemsHtml}</div>
                            </details>
                        </td>
                        <td class="p-6">
                            <p class="font-bold text-sm text-[#064E3B]">${staffName}</p>
                            <p class="text-[10px] text-[#059669] uppercase italic font-bold">${order.userPosition || 'Staff'}</p>
                        </td>
                        <td class="p-6 text-center">
                            <span class="px-3 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest ${statusClass}">${order.status}</span>
                        </td>
                        <td class="p-6 font-black text-[#064E3B]">
                            Rs. ${order.total.toLocaleString()}
                            <p class="text-[9px] text-emerald-600">Savings: Rs. ${order.savings.toLocaleString()}</p>
                        </td>
                        <td class="p-6 text-right">
                            <button onclick="downloadAdminInvoice('${id}')" class="bg-[#059669] text-white p-2 rounded-xl hover:bg-[#064E3B] transition">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>`;
                });

                document.getElementById('totalRevenueDisplay').innerText = `Rs. ${totalRev.toLocaleString()}`;
                document.getElementById('totalSavingsDisplay').innerText = `Rs. ${totalSave.toLocaleString()}`;
                lucide.createIcons();
            });
        };

        window.dispatchIndividualItem = async (orderId, itemIndex) => {
            if(!confirm("මෙම භාණ්ඩය Dispatch කිරීමට අවශ්‍යද?")) return;
            try {
                const orderRef = doc(db, "orders", orderId);
                const orderSnap = await getDoc(orderRef);
                const orderData = orderSnap.data();
                let items = [...orderData.items];
                
                items[itemIndex].status = "Dispatched";
                const allDispatched = items.every(i => i.status === "Dispatched");
                
                const updatePayload = { items: items };
                if(allDispatched) updatePayload.status = "Dispatched";
                await updateDoc(orderRef, updatePayload);

                const itemToDispatch = items[itemIndex];
                const itemRef = doc(db, "items", itemToDispatch.itemId);
                const itemSnap = await getDoc(itemRef);
                
                await addDoc(collection(db, "inventory_logs"), {
                    itemId: itemToDispatch.itemId,
                    itemName: itemToDispatch.name,
                    type: "OUT",
                    qty: itemToDispatch.qty,
                    balance: itemSnap.exists() ? itemSnap.data().stock : 0,
                    processedBy: currentAdminName,
                    createdAt: new Date(),
                    note: `Dispatched from Order #${orderData.orderNo || orderId.substring(0,8)}`
                });

                alert("භාණ්ඩය Dispatch කළා සහ Bin Card එකට ඇතුළත් කළා!");
            } catch (e) { alert("Error: " + e.message); }
        };

        window.setStatusFilter = (status) => {
            currentStatusFilter = status;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
            document.getElementById('tab-' + status).classList.add('tab-active');
            loadOrders();
        };

        window.setPositionFilter = (pos) => {
            currentPositionFilter = pos;
            loadOrders();
        };

        window.clearAllOrders = async () => {
            if (!confirm("අවධානයයි! සියලුම ඕඩර් හිස්ට්‍රිය මැකීමට ඔබට විශ්වාසද? මෙය නැවත ලබා ගත නොහැක.")) return;
            try {
                const querySnapshot = await getDocs(collection(db, "orders"));
                const deletePromises = querySnapshot.docs.map(d => deleteDoc(doc(db, "orders", d.id)));
                await Promise.all(deletePromises);
                alert("සියලුම ඕඩර් හිස්ට්‍රිය සාර්ථකව මකා දමන ලදී.");
            } catch (e) { alert("Error: " + e.message); }
        };

        window.downloadAdminInvoice = async (orderId) => {
            const docSnap = await getDoc(doc(db, "orders", orderId));
            if (docSnap.exists()) {
                const data = docSnap.data();
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ unit: 'mm', format: [100, 150] });
                pdf.setFont("helvetica", "bold");
                pdf.setTextColor(5, 150, 105); 
                pdf.text("PMM WELFARE RECEIPT", 50, 15, { align: "center" });
                pdf.setTextColor(0, 0, 0); pdf.setFontSize(9);
                pdf.text(`Order No: #${data.orderNo || orderId.substring(0,8)}`, 10, 30);
                pdf.text(`Staff: ${data.staffName}`, 10, 38);
                pdf.text(`Role: ${data.userPosition}`, 10, 44);
                pdf.text(`Date: ${data.createdAt?.toDate().toLocaleDateString()}`, 10, 50);
                pdf.text("--------------------------------------------------", 50, 58, { align: "center" });
                let y = 68;
                (data.items || []).forEach(item => {
                    pdf.text(`${item.name} (x${item.qty})`, 10, y);
                    pdf.text(`Rs. ${(item.welfarePrice * item.qty).toLocaleString()}`, 90, y, { align: "right" });
                    y += 8;
                });
                pdf.text("--------------------------------------------------", 50, y + 5, { align: "center" });
                pdf.setFontSize(11);
                pdf.text(`TOTAL: Rs. ${data.total.toLocaleString()}`, 10, y + 15);
                pdf.setFontSize(9);
                pdf.setTextColor(5, 150, 105);
                pdf.text(`You Saved: Rs. ${data.savings.toLocaleString()}`, 10, y + 22);
                pdf.save(`Order_${data.orderNo || orderId.substring(0,5)}.pdf`);
            }
        };

        // --- Purchase Report Logic ---
        window.exportPurchaseReport = async () => {
            try {
                // 1. Pending ඕඩර්ස් ලබා ගැනීම
                const qOrders = query(collection(db, "orders"), where("status", "==", "Pending"));
                const orderSnap = await getDocs(qOrders);
                if (orderSnap.empty) return alert("දැනට පෙන්ඩින් ඕඩර්ස් කිසිවක් නොමැත!");

                // 2. අයිටම් වල අවශ්‍යතාවය ගණනය කිරීම
                const summary = {};
                orderSnap.forEach(d => {
                    const data = d.data();
                    (data.items || []).forEach(item => {
                        if (item.status !== "Dispatched" && item.status !== "Completed") {
                            if (!summary[item.name]) summary[item.name] = { needed: 0, itemId: item.itemId };
                            summary[item.name].needed += item.qty;
                        }
                    });
                });

                // 3. දැනට ඇති ස්ටොක් ප්‍රමාණයන් ලබා ගැනීම
                const itemSnap = await getDocs(collection(db, "items"));
                itemSnap.forEach(d => {
                    for (let name in summary) {
                        if (summary[name].itemId === d.id) summary[name].currentStock = d.data().stock || 0;
                    }
                });

                // 4. PDF සෑදීම
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                pdf.setFont("helvetica", "bold");
                pdf.setFontSize(18); pdf.setTextColor(5, 150, 105);
                pdf.text("PMM WELFARE - PURCHASE REPORT", 105, 20, { align: "center" });
                pdf.setFontSize(10); pdf.setTextColor(100);
                pdf.text(`Generated: ${new Date().toLocaleString()}`, 105, 28, { align: "center" });
                
                pdf.setFontSize(11); pdf.setTextColor(0);
                pdf.setFillColor(240, 253, 244);
                pdf.rect(15, 35, 180, 10, 'F');
                pdf.text("Item Name", 20, 42); pdf.text("Required Qty", 100, 42);
                pdf.text("Stock Available", 140, 42); pdf.text("Shortage", 175, 42);
                pdf.line(15, 45, 195, 45);

                let y = 55; pdf.setFont("helvetica", "normal");
                for (let name in summary) {
                    const item = summary[name];
                    const stock = item.currentStock || 0;
                    const shortage = Math.max(0, item.needed - stock);
                    if (y > 270) { pdf.addPage(); y = 20; }
                    pdf.text(name, 20, y);
                    pdf.text(item.needed.toString(), 110, y, { align: "center" });
                    pdf.text(stock.toString(), 150, y, { align: "center" });
                    if (shortage > 0) {
                        pdf.setTextColor(220, 38, 38); pdf.setFont("helvetica", "bold");
                        pdf.text(shortage.toString(), 182, y, { align: "center" });
                        pdf.setTextColor(0); pdf.setFont("helvetica", "normal");
                    } else { pdf.text("0", 182, y, { align: "center" }); }
                    y += 10; pdf.setDrawColor(240); pdf.line(15, y - 5, 195, y - 5);
                }
                pdf.save(`Purchase_List_${new Date().toISOString().slice(0,10)}.pdf`);
            } catch (e) { alert("Report generation failed!"); }
        };

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth).then(() => window.location.href = "admin-login.html"));
        lucide.createIcons();
    </script>
</body>
</html>