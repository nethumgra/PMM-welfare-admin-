<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - PMM Welfare Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F0FDF4; }
        ::-webkit-scrollbar-thumb { background: #059669; border-radius: 10px; }
      .tab-active { 
    background-color: #059669 !important; 
    color: white !important; 
}
        
        /* Sidebar Transition */
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body class="bg-[#F0FDF4] text-[#064E3B] font-sans">

    <div id="mobileOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden backdrop-blur-sm"></div>

    <div class="flex min-h-screen">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-[#064E3B] text-white sidebar-transition transform -translate-x-full lg:translate-x-0 shadow-2xl overflow-y-auto">
            <div class="p-8 border-b border-emerald-800/50 flex justify-between items-center">
                <h1 class="text-2xl font-black italic flex items-center gap-2">
                    <i data-lucide="box"></i> PMM Welfare.
                </h1>
                <button onclick="toggleSidebar()" class="lg:hidden text-white/50 hover:text-white">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <nav class="mt-6 px-4 space-y-2">
                <a href="admin.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition">
                    <i data-lucide="layout-dashboard"></i> Dashboard
                </a>
                <a href="admin-bin-card.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition">
                    <i data-lucide="clipboard-list"></i> Bin Card
                </a>
                <a href="admin-items.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition">
                    <i data-lucide="package"></i> Store Items
                </a>
                <a href="admin-orders.html" class="flex items-center gap-3 p-4 rounded-2xl bg-emerald-600/30 border border-emerald-500/30 transition">
                    <i data-lucide="shopping-bag"></i> Orders
                </a>
                <a href="admin-staff.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition group">
                    <i data-lucide="users"></i> Staff Members
                </a>
                <div class="pt-10">
                    <button id="logoutBtn" class="flex items-center gap-3 p-4 w-full rounded-2xl hover:bg-red-500 transition text-red-100">
                        <i data-lucide="log-out"></i> Logout
                    </button>
                </div>
            </nav>
        </aside>

        <main class="flex-1 lg:ml-72 p-4 md:p-8 lg:p-10">
            <header class="flex flex-col gap-6 mb-8">
                <div class="flex justify-between items-center lg:items-start">
                    <div class="flex items-center gap-4">
                        <button onclick="toggleSidebar()" class="lg:hidden p-3 bg-white rounded-2xl shadow-sm border border-emerald-100 text-[#059669]">
                            <i data-lucide="menu"></i>
                        </button>
                        <div>
                            <h2 class="text-2xl md:text-3xl font-black text-[#064E3B]">Order Management</h2>
                            <p class="text-[#059669] text-sm font-medium italic hidden md:block">Track lifecycle from Pending to Completed</p>
                        </div>
                    </div>
                    
                    <div class="hidden lg:flex items-center gap-3">
                        <div class="bg-white py-2 px-6 rounded-2xl shadow-sm border border-[#DCFCE7] text-right">
                            <p class="font-black text-[#064E3B]" id="adminNameDisplay">Admin</p>
                            <p class="text-[10px] uppercase tracking-widest text-[#059669] font-bold">Main Admin</p>
                        </div>
                    </div>
                </div>

                <div class="flex flex-wrap items-center gap-3">
                    <button onclick="exportPurchaseReport()" class="flex-1 md:flex-none bg-blue-50 text-blue-600 px-5 py-3 rounded-2xl text-[10px] font-black uppercase hover:bg-blue-600 hover:text-white transition border border-blue-100 flex items-center justify-center gap-2">
                        <i data-lucide="shopping-cart" class="w-4 h-4"></i> Purchase Report
                    </button>
                    
                    <button onclick="clearAllOrders()" class="flex-1 md:flex-none bg-red-50 text-red-600 px-5 py-3 rounded-2xl text-[10px] font-black uppercase hover:bg-red-600 hover:text-white transition border border-red-100 flex items-center justify-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> Clear History
                    </button>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-8">
                <div class="bg-white p-6 rounded-[2.5rem] border border-[#DCFCE7] shadow-sm flex items-center gap-6">
                    <div class="bg-emerald-100 p-4 rounded-3xl text-emerald-600 shrink-0"><i data-lucide="trending-up"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-[#059669] uppercase tracking-widest">Total Staff Savings</p>
                        <p class="text-xl md:text-2xl font-black text-emerald-600" id="totalSavingsDisplay">Rs. 0.00</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-[2.5rem] border border-[#DCFCE7] shadow-sm flex items-center gap-6">
                    <div class="bg-emerald-50 p-4 rounded-3xl text-[#064E3B] shrink-0"><i data-lucide="shopping-cart"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-[#059669] uppercase tracking-widest">Total Welfare Sales</p>
                        <p class="text-xl md:text-2xl font-black text-[#064E3B]" id="totalRevenueDisplay">Rs. 0.00</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-col xl:flex-row items-stretch gap-4 mb-8">
                <div class="relative flex-1">
                    <input type="text" id="orderSearchInput" oninput="loadOrders()" placeholder="Search Order No or Staff Name..." 
                        class="w-full bg-white border border-[#DCFCE7] text-[#064E3B] text-sm font-bold py-4 px-12 rounded-2xl focus:outline-none focus:ring-2 focus:ring-[#059669] shadow-sm">
                    <i data-lucide="search" class="absolute left-5 top-1/2 -translate-y-1/2 text-[#059669] w-5 h-5"></i>
                </div>

                <div class="flex flex-col md:flex-row gap-4">
                    <div class="bg-white p-2 rounded-2xl shadow-sm border border-[#DCFCE7] flex gap-1 overflow-x-auto no-scrollbar">
                        <button onclick="setStatusFilter('all')" id="tab-all" class="tab-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase transition tab-active whitespace-nowrap">All</button>
                        <button onclick="setStatusFilter('Pending')" id="tab-Pending" class="tab-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase transition text-[#059669] hover:bg-[#F0FDF4] whitespace-nowrap">Pending</button>
                        <button onclick="setStatusFilter('Dispatched')" id="tab-Dispatched" class="tab-btn px-6 py-3 rounded-xl text-[10px] font-black uppercase transition text-[#059669] hover:bg-[#F0FDF4] whitespace-nowrap">Dispatched</button>
                    </div>

                    <div class="relative">
                      <select id="positionFilter" onchange="setPositionFilter(this.value)" 
                            class="w-full bg-white border border-[#DCFCE7] text-[#064E3B] text-[10px] font-black uppercase py-4 px-6 pr-12 rounded-2xl appearance-none focus:outline-none focus:ring-2 focus:ring-[#059669] shadow-sm cursor-pointer h-full">
                            <option value="all">All Positions</option>
                      </select>
                      <i data-lucide="chevron-down" class="absolute right-5 top-1/2 -translate-y-1/2 text-[#059669] w-4 h-4 pointer-events-none"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-[2rem] md:rounded-[3rem] shadow-sm border border-[#DCFCE7] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[900px]">
                        <thead>
                            <tr class="bg-[#F0FDF4] text-[#059669] text-[10px] uppercase tracking-widest border-b border-[#DCFCE7]">
                                <th class="p-6">Order No & Items</th>
                                <th class="p-6">Staff Member</th>
                                <th class="p-6">Date</th>
                                <th class="p-6 text-center">Status</th>
                                <th class="p-6">Financials</th>
                                <th class="p-6 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody" class="text-sm font-medium text-[#064E3B]"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, doc, getDoc, orderBy, updateDoc, deleteDoc, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3jlpc_vbUydda2XpDj5Xd1J8kVei9v8U",
            authDomain: "inventory-c3cca.firebaseapp.com",
            projectId: "inventory-c3cca",
            storageBucket: "inventory-c3cca.firebasestorage.app",
            messagingSenderId: "396140403894",
            appId: "1:396140403894:web:316617b8e390f8b0575a17"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentStatusFilter = 'all';
        let currentPositionFilter = 'all';
        let unsubscribeOrders = null;
        let currentAdminName = "Admin";
        let canClearOrders = false;

        // Sidebar Control
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('mobileOverlay');
            if (sb.classList.contains('-translate-x-full')) {
                sb.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sb.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        };

  onAuthStateChanged(auth, async (user) => {
    if (user) {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const userData = userDoc.data();

        if (userData.role === "admin") {
            const hasAccess = userData.isSuperAdmin || userData.email === "admin@inventory.com" || (userData.permissions && userData.permissions.orders);
            
            if (hasAccess) {
                // Clear History අවසරය තියෙනවද බලන්න
                canClearOrders = userData.isSuperAdmin || (userData.permissions && userData.permissions.canClearOrders);
                
                currentAdminName = userData.name;
                document.getElementById('adminNameDisplay').innerText = currentAdminName;
                loadOrders();
                loadPositionOptions();
            } else {
                alert("අවසර නැත!");
                window.location.href = "admin.html";
            }
        }
    }
});

        // Load Unique Positions to Select
        async function loadPositionOptions() {
            const select = document.getElementById('positionFilter');
            const rolesSnap = await getDocs(collection(db, "roles"));
            rolesSnap.forEach(roleDoc => {
                const roleName = roleDoc.data().name;
                const opt = document.createElement('option');
                opt.value = roleName;
                opt.innerText = roleName;
                select.appendChild(opt);
            });
        }

        window.loadOrders = () => {
            const tableBody = document.getElementById('ordersTableBody');
            const searchTerm = document.getElementById('orderSearchInput').value.toLowerCase().trim();
            if (unsubscribeOrders) unsubscribeOrders();

            let constraints = [];
            if (currentStatusFilter !== 'all') constraints.push(where("status", "==", currentStatusFilter));
            if (currentPositionFilter !== 'all') constraints.push(where("userPosition", "==", currentPositionFilter));
            constraints.push(orderBy("createdAt", "desc"));

            const q = query(collection(db, "orders"), ...constraints);

            unsubscribeOrders = onSnapshot(q, (snap) => {
                tableBody.innerHTML = '';
                let totalRev = 0; let totalSave = 0;

                snap.forEach(d => {
                    const order = d.data();
                    const id = d.id;
                    const orderNo = order.orderNo || id.substring(0, 8).toUpperCase();
                    const staffName = order.staffName || "Unknown Staff";
                    
                    if (searchTerm && !orderNo.toLowerCase().includes(searchTerm) && !staffName.toLowerCase().includes(searchTerm)) return;

                    if(order.status !== "Cancelled") {
                        (order.items || []).forEach(item => {
                            if(item.status === "Dispatched" || item.status === "Completed") {
                                totalRev += (item.welfarePrice * item.qty);
                                totalSave += ((item.mrpPrice - item.welfarePrice) * item.qty);
                            }
                        });
                    }

                    let statusClass = "bg-amber-100 text-amber-600";
                    if(order.status === "Dispatched") statusClass = "bg-blue-100 text-blue-600";
                    if(order.status === "Completed") statusClass = "bg-emerald-100 text-emerald-600";
                    if(order.status === "Cancelled") statusClass = "bg-red-100 text-red-600";

                    let itemsHtml = (order.items || []).map((item, index) => {
                        const isActionable = (item.status !== 'Dispatched' && item.status !== 'Rejected' && order.status !== 'Cancelled');
                        
                        return `
                        <div class="flex justify-between items-center p-3 border-b border-emerald-50 last:border-0 bg-white">
                            <div class="flex items-center gap-3">
                                <span class="w-2 h-2 rounded-full ${item.status === 'Dispatched' ? 'bg-blue-500' : (item.status === 'Rejected' ? 'bg-red-500' : 'bg-amber-500')}"></span>
                                <div>
                                    <p class="font-bold text-[11px]">${item.name} (x${item.qty})</p>
                                    <p class="text-[9px] font-black uppercase ${item.status === 'Rejected' ? 'text-red-500' : 'text-gray-400'}">${item.status || 'Pending'}</p>
                                </div>
                            </div>
                            <div class="flex gap-1">
                                ${isActionable ? `
                                    <button onclick="dispatchIndividualItem('${id}', ${index})" class="text-[9px] bg-emerald-600 text-white px-3 py-1.5 rounded-lg font-black hover:bg-emerald-700 transition uppercase">Dispatch</button>
                                    <button onclick="rejectIndividualItem('${id}', ${index})" class="text-[9px] bg-red-600 text-white px-3 py-1.5 rounded-lg font-black hover:bg-red-700 transition uppercase">Reject</button>
                                ` : (item.status === 'Dispatched' ? '<i data-lucide="check-circle" class="w-4 h-4 text-blue-500"></i>' : (item.status === 'Rejected' ? '<i data-lucide="x-circle" class="w-4 h-4 text-red-500"></i>' : ''))}
                            </div>
                        </div>`;
                    }).join('');

                    tableBody.innerHTML += `
                    <tr class="border-b border-[#F0FDF4] hover:bg-[#F0FDF4]/50 transition">
                        <td class="p-6">
                            <p class="font-black text-[#064E3B] text-lg tracking-tight">${orderNo}</p> 
                            <details class="mt-3 group cursor-pointer">
                                <summary class="list-none outline-none flex items-center gap-2 text-[#059669] text-[10px] font-black uppercase underline decoration-dotted">
                                    <i data-lucide="chevron-right" class="w-3 h-3 group-open:rotate-90 transition"></i> 
                                    View ${order.items ? order.items.length : 0} Items
                                </summary>
                                <div class="mt-3 border border-emerald-100 rounded-2xl overflow-hidden shadow-inner">${itemsHtml}</div>
                            </details>
                        </td>
                        <td class="p-6">
                            <p class="font-bold text-sm text-[#064E3B]">${staffName}</p>
                            <p class="text-[10px] text-[#059669] uppercase italic font-bold">${order.userPosition || 'Staff'}</p>
                        </td>
                        <td class="p-6">
                            <p class="font-bold text-sm text-[#064E3B] whitespace-nowrap">${order.createdAt?.toDate ? order.createdAt.toDate().toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'}) : '—'}</p>
                            <p class="text-[10px] text-gray-400 font-bold whitespace-nowrap">${order.createdAt?.toDate ? order.createdAt.toDate().toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'}) : ''}</p>
                        </td>
                        <td class="p-6 text-center">
                            <span class="px-3 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest ${statusClass}">${order.status}</span>
                        </td>
                        <td class="p-6 font-black text-[#064E3B]">
                            Rs. ${order.total.toLocaleString()}
                            <p class="text-[9px] text-emerald-600">Savings: Rs. ${order.savings.toLocaleString()}</p>
                        </td>
                        <td class="p-6 text-right">
                            <button onclick="downloadAdminInvoice('${id}')" class="bg-[#059669] text-white p-2.5 rounded-xl hover:bg-[#064E3B] transition">
                                <i data-lucide="download" class="w-4 h-4"></i>
                            </button>
                        </td>
                    </tr>`;
                });

                document.getElementById('totalRevenueDisplay').innerText = `Rs. ${totalRev.toLocaleString()}`;
                document.getElementById('totalSavingsDisplay').innerText = `Rs. ${totalSave.toLocaleString()}`;
                lucide.createIcons();
            });
        };

        window.dispatchIndividualItem = async (orderId, itemIndex) => {
            if(!confirm("මෙම භාණ්ඩය Dispatch කිරීමට අවශ්‍යද?")) return;
            try {
                const orderRef = doc(db, "orders", orderId);
                const orderSnap = await getDoc(orderRef);
                const orderData = orderSnap.data();
                let items = [...orderData.items];
                
                items[itemIndex].status = "Dispatched";
                
                const allProcessed = items.every(i => i.status === "Dispatched" || i.status === "Rejected");
                const updatePayload = { items: items };
                if(allProcessed) updatePayload.status = "Dispatched";
                
                await updateDoc(orderRef, updatePayload);

                const itemToDispatch = items[itemIndex];
                const itemRef = doc(db, "items", itemToDispatch.itemId);
                const itemSnap = await getDoc(itemRef);
                
               await addDoc(collection(db, "inventory_logs"), {
                    itemId: itemToDispatch.itemId,
                    itemName: itemToDispatch.name,
                    type: "OUT",
                    qty: itemToDispatch.qty,
                    balance: itemSnap.exists() ? itemSnap.data().stock : 0,
                    processedBy: currentAdminName,
                    createdAt: new Date(),
                    orderNo: orderData.orderNo || orderId.substring(0,8), // Order ID එක පැහැදිලිව ලබා දීම
                    note: `Dispatched from Order #${orderData.orderNo || orderId.substring(0,8)}`
                });

                alert("භාණ්ඩය Dispatch කළා සහ Bin Card එකට ඇතුළත් කළා!");
            } catch (e) { alert("Error: " + e.message); }
        };

       window.rejectIndividualItem = async (orderId, itemIndex) => {
    if(!confirm("මෙම භාණ්ඩය ප්‍රතික්ෂේප (Reject) කිරීමට අවශ්‍යද? එවිට ඕඩර් එකේ මුළු එකතුවද අඩු වනු ඇත.")) return;
    
    try {
        const orderRef = doc(db, "orders", orderId);
        const orderSnap = await getDoc(orderRef);
        const orderData = orderSnap.data();
        let items = [...orderData.items];
        
        // ප්‍රතික්ෂේප කරන අයිතමය තෝරා ගැනීම
        const rejectedItem = items[itemIndex];

        // දැනටමත් Reject කර ඇත්නම් නැවත අඩු කිරීම වැළැක්වීමට
        if (rejectedItem.status === "Rejected") {
            alert("මෙම භාණ්ඩය දැනටමත් ප්‍රතික්ෂේප කර ඇත.");
            return;
        }

        // 1. අයිතමයේ මිල ගණන් ගණනය කිරීම
        const itemWelfareTotal = rejectedItem.welfarePrice * rejectedItem.qty;
        const itemSavingsTotal = (rejectedItem.mrpPrice - rejectedItem.welfarePrice) * rejectedItem.qty;

        // 2. අයිතමයේ ස්ටේටස් එක වෙනස් කිරීම
        items[itemIndex].status = "Rejected";

        // 3. ඕඩර් එකේ මුළු එකතුව (Total) සහ ඉතිරිය (Savings) යාවත්කාලීන කිරීම
        const newTotal = orderData.total - itemWelfareTotal;
        const newSavings = orderData.savings - itemSavingsTotal;

      const allProcessed = items.every(i => i.status === "Dispatched" || i.status === "Rejected");
// සියලුම අයිතම ප්‍රතික්ෂේප (Rejected) වී ඇත්දැයි පරීක්ෂා කිරීම
const areAllRejected = items.every(i => i.status === "Rejected");

const updatePayload = { 
    items: items,
    total: Math.max(0, newTotal), 
    savings: Math.max(0, newSavings)
};

if (allProcessed) {
    if (areAllRejected) {
        // සියලුම අයිතම Rejected නම් මුළු ඕඩර් එකම Cancelled ලෙස පෙන්වයි
        updatePayload.status = "Cancelled";
    } else {
        // අවම වශයෙන් එකක් හෝ Dispatched වී ඇත්නම් Dispatched ලෙස පෙන්වයි
        updatePayload.status = "Dispatched";
    }
}

await updateDoc(orderRef, updatePayload);
        
        alert("භාණ්ඩය ප්‍රතික්ෂේප කළා සහ මුළු එකතුව යාවත්කාලීන කළා.");
    } catch (e) { 
        alert("Error: " + e.message); 
    }
};

        window.setStatusFilter = (status) => {
            currentStatusFilter = status;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active'));
            document.getElementById('tab-' + status).classList.add('tab-active');
            loadOrders();
        };

        window.setPositionFilter = (pos) => {
            currentPositionFilter = pos;
            loadOrders();
        };
window.clearAllOrders = async () => {
    // 1. මුලින්ම අවසර තියෙනවද කියලා බලනවා
    if (!canClearOrders) {
        alert("සමාවන්න! ඕඩර් හිස්ට්‍රිය මැකීමට ඔබට අවසර නැත. කරුණාකර Super Admin සම්බන්ධ කරගන්න.");
        return; // අවසර නැත්නම් මෙතනින් කෝඩ් එක නවතිනවා
    }

    // 2. අවසර තියෙනවා නම් තහවුරු කිරීමක් අහනවා
    if (!confirm("අවධානයයි! සියලුම ඕඩර් හිස්ට්‍රිය මැකීමට ඔබට විශ්වාසද? මෙය නැවත ලබා ගත නොහැක.")) return;

    try {
        const querySnapshot = await getDocs(collection(db, "orders"));
        
        // එකින් එක ඩිලීට් කිරීමේ පොරොන්දු (Promises) සෑදීම
        const deletePromises = querySnapshot.docs.map(d => deleteDoc(doc(db, "orders", d.id)));
        
        // සියල්ල එකවර ක්‍රියාත්මක කිරීම
        await Promise.all(deletePromises);
        
        alert("සියලුම ඕඩර් හිස්ට්‍රිය සාර්ථකව මකා දමන ලදී.");
    } catch (e) { 
        alert("Error: " + e.message); 
    }
};

window.downloadAdminInvoice = async (orderId) => {
    const docSnap = await getDoc(doc(db, "orders", orderId));
    if (docSnap.exists()) {
        const data = docSnap.data();
        const { jsPDF } = window.jspdf;
        // කොළය ටිකක් දිගට ගත්තා අයිටම් ගොඩක් තිබ්බොත් පේන්න
        const pdf = new jsPDF({ unit: 'mm', format: [100, 160] });
        
        // ඕඩර් එක කැන්සල් වී ඇත්දැයි පරීක්ෂා කිරීම
        const isCancelled = data.status === 'Cancelled';

        // Header
        pdf.setFont("helvetica", "bold");
        pdf.setTextColor(5, 150, 105); 
        pdf.text("PMM WELFARE RECEIPT", 50, 15, { align: "center" });
        
        // ඕඩර් එක කැන්සල් නම් රතු පාටින් "ORDER CANCELLED" ලේබලය එක් කිරීම
        if (isCancelled) {
            pdf.setTextColor(220, 38, 38); // රතු පැහැය
            pdf.setFontSize(14);
            pdf.text("ORDER CANCELLED", 50, 22, { align: "center" });
        }

        // Order Info
        pdf.setTextColor(0, 0, 0); 
        pdf.setFontSize(9);
        // කැන්සල් නෝටිස් එක නිසා අකුරු පල්ලෙහාට ගත්තා
        const startY = isCancelled ? 32 : 30;
        pdf.text(`Order No: #${data.orderNo || orderId.substring(0,8)}`, 10, startY);
        pdf.text(`Staff: ${data.staffName}`, 10, startY + 8);
        pdf.text(`Role: ${data.userPosition}`, 10, startY + 14);
        pdf.text(`Date: ${data.createdAt?.toDate().toLocaleDateString()}`, 10, startY + 20);
        
        pdf.setDrawColor(220, 220, 220);
        pdf.line(10, startY + 25, 90, startY + 25);
        
        let y = startY + 35;
        (data.items || []).forEach(item => {
            const isRejected = item.status === 'Rejected';
            // ඕඩර් එක කැන්සල් නම් සියලු අයිතම කැන්සල් ලෙස පෙන්වයි
            const statusText = isCancelled ? 'CANCELLED' : (item.status ? item.status.toUpperCase() : 'PENDING');
            
            // අයිටම් එකේ නම (Bold)
            pdf.setFont("helvetica", "bold");
            pdf.setFontSize(8);
            
            // කැන්සල් හෝ රීජෙක්ට් නම් රතු පැහැයෙන් පෙන්වීම
            if(isCancelled || isRejected) pdf.setTextColor(220, 38, 38);
            else pdf.setTextColor(0, 0, 0);
            
            pdf.text(`${item.name} (x${item.qty})`, 10, y);
            
            // මිල පෙන්වීම (කැන්සල් නම් Rs. 0 පෙන්වයි)
            const priceLabel = (isCancelled || isRejected) ? "Rs. 0" : `Rs. ${(item.welfarePrice * item.qty).toLocaleString()}`;
            pdf.text(priceLabel, 90, y, { align: "right" });
            
            // ස්ටේටස් එක පල්ලෙහායින් (Normal font)
            y += 4;
            pdf.setFont("helvetica", "normal");
            pdf.setFontSize(7);
            pdf.text(`Status: ${statusText}`, 10, y);
            
            y += 8; // පරතරය වැඩි කළා Overlap වීම වැළැක්වීමට
            pdf.setTextColor(0, 0, 0); // වර්ණය Reset කිරීම
        });
        
        pdf.setDrawColor(220, 220, 220);
        pdf.line(10, y, 90, y);
        
        // Final Totals
        y += 10;
        pdf.setFont("helvetica", "bold");
        pdf.setFontSize(11);
        
        // කැන්සල් ඕඩර් එකක මුළු එකතුව සහ ඉතිරිය 0 ලෙස සකස් කිරීම
        const finalTotal = isCancelled ? 0 : (data.total || 0);
        const finalSavings = isCancelled ? 0 : (data.savings || 0);

        pdf.text(`TOTAL: Rs. ${finalTotal.toLocaleString()}`, 10, y);
        
        y += 7;
        pdf.setFontSize(9);
        pdf.setTextColor(5, 150, 105);
        pdf.text(`Welfare Savings: Rs. ${finalSavings.toLocaleString()}`, 10, y);
        
        pdf.save(`Order_${data.orderNo || orderId.substring(0,5)}.pdf`);
    }
};
        window.exportPurchaseReport = async () => {
            try {
                const qOrders = query(collection(db, "orders"), where("status", "==", "Pending"));
                const orderSnap = await getDocs(qOrders);
                if (orderSnap.empty) return alert("දැනට පෙන්ඩින් ඕඩර්ස් කිසිවක් නොමැත!");

                const summary = {};
                orderSnap.forEach(d => {
                    const data = d.data();
                    (data.items || []).forEach(item => {
                        if (item.status !== "Dispatched" && item.status !== "Completed" && item.status !== "Rejected") {
                            if (!summary[item.name]) summary[item.name] = { needed: 0, itemId: item.itemId };
                            summary[item.name].needed += item.qty;
                        }
                    });
                });

                const itemSnap = await getDocs(collection(db, "items"));
                itemSnap.forEach(d => {
                    for (let name in summary) {
                        if (summary[name].itemId === d.id) summary[name].currentStock = d.data().stock || 0;
                    }
                });

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                pdf.setFont("helvetica", "bold");
                pdf.setFontSize(18); pdf.setTextColor(5, 150, 105);
                pdf.text("PMM WELFARE - PURCHASE REPORT", 105, 20, { align: "center" });
                pdf.setFontSize(10); pdf.setTextColor(100);
                pdf.text(`Generated: ${new Date().toLocaleString()}`, 105, 28, { align: "center" });
                
                pdf.setFontSize(11); pdf.setTextColor(0);
                pdf.setFillColor(240, 253, 244);
                pdf.rect(15, 35, 180, 10, 'F');
                pdf.text("Item Name", 20, 42); pdf.text("Required Qty", 100, 42);
                pdf.text("Stock Available", 140, 42); pdf.text("Shortage", 175, 42);
                pdf.line(15, 45, 195, 45);

                let y = 55; pdf.setFont("helvetica", "normal");
                for (let name in summary) {
                    const item = summary[name];
                    const stock = item.currentStock || 0;
                    const shortage = Math.max(0, item.needed - stock);
                    if (y > 270) { pdf.addPage(); y = 20; }
                    pdf.text(name, 20, y);
                    pdf.text(item.needed.toString(), 110, y, { align: "center" });
                    pdf.text(stock.toString(), 150, y, { align: "center" });
                    if (shortage > 0) {
                        pdf.setTextColor(220, 38, 38); pdf.setFont("helvetica", "bold");
                        pdf.text(shortage.toString(), 182, y, { align: "center" });
                        pdf.setTextColor(0); pdf.setFont("helvetica", "normal");
                    } else { pdf.text("0", 182, y, { align: "center" }); }
                    y += 10; pdf.setDrawColor(240); pdf.line(15, y - 5, 195, y - 5);
                }
                pdf.save(`Purchase_List_${new Date().toISOString().slice(0,10)}.pdf`);
            } catch (e) { alert("Report generation failed!"); }
        };

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth).then(() => window.location.href = "admin-login.html"));
        lucide.createIcons();
    </script>
</body>
</html>