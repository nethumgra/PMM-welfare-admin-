<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Management - PMM Welfare Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F0FDF4; }
        ::-webkit-scrollbar-thumb { background: #059669; border-radius: 10px; }
        .tab-active { background-color: #059669; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body class="bg-[#F0FDF4] text-[#064E3B] font-sans">

    <div class="flex min-h-screen">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-[#064E3B] text-white transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out shadow-2xl">
            <div class="p-8 border-b border-emerald-800/50">
                <h1 class="text-2xl font-black italic flex items-center justify-center gap-2">
                    <i data-lucide="box"></i> PMM Welfare.
                </h1>
            </div>
            <nav class="mt-6 px-4 space-y-2">
                <a href="admin.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition">
                    <i data-lucide="layout-dashboard"></i> Dashboard
                </a>
                <a href="admin-bin-card.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition">
                    <i data-lucide="clipboard-list"></i> Bin Card
                </a>
                <a href="admin-items.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition">
                    <i data-lucide="package"></i> Store Items
                </a>
                <a href="admin-orders.html" class="flex items-center gap-3 p-4 rounded-2xl bg-emerald-600/30 border border-emerald-500/30 transition">
                    <i data-lucide="shopping-bag"></i> Orders
                </a>
                <a href="admin-staff.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition group">
                    <i data-lucide="users"></i> Staff Members
                </a>
                <a href="admin-settings.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition group">
                    <i data-lucide="settings"></i> System Settings
                </a>
                <div class="pt-20">
                    <button id="logoutBtn" class="flex items-center gap-3 p-4 w-full rounded-2xl hover:bg-red-500 transition text-red-100">
                        <i data-lucide="log-out"></i> Logout
                    </button>
                </div>
            </nav>
        </aside>

        <main class="flex-1 lg:ml-64 p-4 lg:p-10">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h2 class="text-3xl font-black text-[#064E3B]">Order Management</h2>
                    <p class="text-[#059669] font-medium italic">Track lifecycle from Pending to Completed</p>
                </div>
                <div class="bg-white py-2 px-6 rounded-2xl shadow-sm border border-[#DCFCE7] text-right">
                    <p class="font-black text-[#064E3B]" id="adminNameDisplay">Admin</p>
                    <p class="text-[10px] uppercase tracking-widest text-[#059669] font-bold">Main Admin</p>
                </div>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-[2.5rem] border border-[#DCFCE7] shadow-sm flex items-center gap-6">
                    <div class="bg-emerald-100 p-4 rounded-3xl text-emerald-600"><i data-lucide="trending-up"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-[#059669] uppercase tracking-widest">Total Staff Savings</p>
                        <p class="text-2xl font-black text-emerald-600" id="totalSavingsDisplay">Rs. 0.00</p>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-[2.5rem] border border-[#DCFCE7] shadow-sm flex items-center gap-6">
                    <div class="bg-emerald-50 p-4 rounded-3xl text-[#064E3B]"><i data-lucide="shopping-cart"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-[#059669] uppercase tracking-widest">Total Welfare Sales</p>
                        <p class="text-2xl font-black text-[#064E3B]" id="totalRevenueDisplay">Rs. 0.00</p>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap items-center gap-4 mb-8">
                <div class="bg-white p-2 rounded-[2rem] shadow-sm border border-[#DCFCE7] flex gap-1 overflow-x-auto w-fit">
                    <button onclick="setStatusFilter('all')" id="tab-all" class="tab-btn px-6 py-3 rounded-full text-[10px] font-black uppercase transition tab-active">All Orders</button>
                    <button onclick="setStatusFilter('Pending')" id="tab-Pending" class="tab-btn px-6 py-3 rounded-full text-[10px] font-black uppercase transition text-[#059669] hover:bg-[#F0FDF4]">Pending</button>
                    <button onclick="setStatusFilter('Dispatched')" id="tab-Dispatched" class="tab-btn px-6 py-3 rounded-full text-[10px] font-black uppercase transition text-[#059669] hover:bg-[#F0FDF4]">Dispatched</button>
                    <button onclick="setStatusFilter('Completed')" id="tab-Completed" class="tab-btn px-6 py-3 rounded-full text-[10px] font-black uppercase transition text-[#059669] hover:bg-[#F0FDF4]">Completed</button>
                </div>

                <div class="relative min-w-[200px]">
                    <select id="positionFilter" onchange="setPositionFilter(this.value)" 
                        class="w-full bg-white border border-[#DCFCE7] text-[#064E3B] text-[10px] font-black uppercase py-4 px-6 rounded-full appearance-none focus:outline-none focus:ring-2 focus:ring-[#059669] shadow-sm cursor-pointer">
                        <option value="all">All Positions</option>
                        <option value="Executive">Executive</option>
                        <option value="Manager">Manager</option>
                        <option value="Staff">Staff</option>
                        <option value="Worker">Worker</option>
                        <option value="Driver">Driver</option>
                        <option value="Security">Security</option>
                    </select>
                    <div class="absolute right-5 top-1/2 -translate-y-1/2 pointer-events-none text-[#059669]">
                        <i data-lucide="chevron-down" class="w-4 h-4"></i>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-[3rem] shadow-sm border border-[#DCFCE7] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-[#F0FDF4] text-[#059669] text-[10px] uppercase tracking-widest border-b border-[#DCFCE7]">
                                <th class="p-6">Order No & Item</th>
                                <th class="p-6">Staff Member</th>
                                <th class="p-6 text-center">Status</th>
                                <th class="p-6">Financials</th>
                                <th class="p-6 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody" class="text-sm font-medium text-[#064E3B]">
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, where, doc, getDoc, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3jlpc_vbUydda2XpDj5Xd1J8kVei9v8U",
            authDomain: "inventory-c3cca.firebaseapp.com",
            projectId: "inventory-c3cca",
            storageBucket: "inventory-c3cca.firebasestorage.app",
            messagingSenderId: "396140403894",
            appId: "1:396140403894:web:316617b8e390f8b0575a17"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentStatusFilter = 'all';
        let currentPositionFilter = 'all'; // New state for position
        let unsubscribeOrders = null;

        // Auth Protection & Init
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === "admin") {
                    document.getElementById('adminNameDisplay').innerText = userDoc.data().name;
                    loadOrders();
                } else { window.location.href = "admin-login.html"; }
            } else { window.location.href = "admin-login.html"; }
        });

        // Load and Listen to Orders with Dual Filtering
        window.loadOrders = () => {
            const tableBody = document.getElementById('ordersTableBody');
            if (unsubscribeOrders) unsubscribeOrders();

            const constraints = [];
            
            // Apply Status Filter
            if (currentStatusFilter !== 'all') {
                constraints.push(where("status", "==", currentStatusFilter));
            }

            // Apply Position Filter (Added machn)
            if (currentPositionFilter !== 'all') {
                constraints.push(where("userPosition", "==", currentPositionFilter));
            }

            constraints.push(orderBy("createdAt", "desc"));

            const q = query(collection(db, "orders"), ...constraints);

            unsubscribeOrders = onSnapshot(q, (snap) => {
                tableBody.innerHTML = '';
                let totalRev = 0;
                let totalSave = 0;
                
                snap.forEach(d => {
                    const order = d.data();
                    const id = d.id;
                    const status = order.status || "Pending";
                    const orderDate = order.createdAt?.toDate().toLocaleDateString() || 'Today';
                    
                    if(status !== "Cancelled") {
                        totalRev += order.total || 0;
                        totalSave += order.savings || 0;
                    }

                    let statusBadgeClass = "bg-amber-100 text-amber-600";
                    if (status === "Dispatched") statusBadgeClass = "bg-blue-100 text-blue-600";
                    if (status === "Completed") statusBadgeClass = "bg-emerald-100 text-emerald-600";
                    if (status === "Cancelled") statusBadgeClass = "bg-red-100 text-red-600";

                    let actionButtons = "";
                    if (status === "Pending") {
                        actionButtons = `
                            <button onclick="updateOrderStatus('${id}', 'Dispatched')" class="text-blue-600 hover:bg-blue-50 p-2 rounded-lg" title="Dispatch">
                                <i data-lucide="truck" class="w-5 h-5"></i>
                            </button>
                            <button onclick="updateOrderStatus('${id}', 'Completed')" class="text-emerald-600 hover:bg-emerald-50 p-2 rounded-lg" title="Complete">
                                <i data-lucide="check-circle" class="w-5 h-5"></i>
                            </button>`;
                    } else if (status === "Dispatched") {
                        actionButtons = `
                            <button onclick="updateOrderStatus('${id}', 'Completed')" class="text-emerald-600 hover:bg-emerald-50 p-2 rounded-lg" title="Complete">
                                <i data-lucide="check-circle" class="w-5 h-5"></i>
                            </button>`;
                    } else {
                        actionButtons = `<span class="text-emerald-500"><i data-lucide="check-check" class="w-5 h-5"></i></span>`;
                    }

                    tableBody.innerHTML += `
                        <tr class="border-b border-[#F0FDF4] hover:bg-[#F0FDF4] transition">
                            <td class="p-6">
                                <p class="font-black text-[#064E3B]">#${id.substring(0,8).toUpperCase()}</p>
                                <p class="font-bold text-[#059669] text-xs">${order.itemName}</p>
                                <p class="text-[9px] text-gray-400 uppercase">${orderDate}</p>
                            </td>
                            <td class="p-6">
                                <p class="font-bold text-sm text-[#064E3B]">${order.staffName}</p>
                                <p class="text-[10px] text-[#059669] uppercase tracking-tighter italic">${order.userPosition}</p>
                            </td>
                            <td class="p-6 text-center">
                                <span class="px-3 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest ${statusBadgeClass}">${status}</span>
                            </td>
                            <td class="p-6">
                                <p class="font-black text-[#064E3B]">Rs. ${order.total.toLocaleString()}</p>
                                <p class="text-[9px] text-emerald-600 font-bold uppercase">Saving: Rs. ${order.savings.toLocaleString()}</p>
                            </td>
                            <td class="p-6 text-right">
                                <div class="flex justify-end items-center gap-2">
                                    ${actionButtons}
                                    <button onclick="downloadAdminInvoice('${id}')" class="bg-[#059669] text-white p-2 rounded-xl hover:bg-[#064E3B] transition">
                                        <i data-lucide="download" class="w-4 h-4"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                });

                document.getElementById('totalRevenueDisplay').innerText = `Rs. ${totalRev.toLocaleString()}`;
                document.getElementById('totalSavingsDisplay').innerText = `Rs. ${totalSave.toLocaleString()}`;
                lucide.createIcons();
            }, (error) => {
                // If there's an index error, it will show here
                console.error("Firestore Error:", error);
                if(error.message.includes("index")) {
                    alert("Filter එක වැඩ කරන්න නම් Firebase වල Index එකක් හදන්න ඕනේ. Browser Console එකේ තියෙන Link එක ක්ලික් කරන්න.");
                }
            });
        };

        // Update Logic
        window.updateOrderStatus = async (id, newStatus) => {
            if(!confirm(`Update order status to ${newStatus}?`)) return;
            try {
                const orderRef = doc(db, "orders", id);
                const updateData = { status: newStatus };
                if(newStatus === 'Dispatched') updateData.dispatchedAt = new Date();
                if(newStatus === 'Completed') updateData.completedAt = new Date();
                
                await updateDoc(orderRef, updateData);
            } catch (e) { alert("Error: " + e.message); }
        };

        // UI Filtering - Status
        window.setStatusFilter = (status) => {
            currentStatusFilter = status;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('text-[#059669]', 'hover:bg-[#F0FDF4]');
            });
            const activeTab = document.getElementById('tab-' + status);
            activeTab.classList.add('tab-active');
            activeTab.classList.remove('text-[#059669]', 'hover:bg-[#F0FDF4]');
            loadOrders();
        };

        // UI Filtering - Position (Added machn)
        window.setPositionFilter = (pos) => {
            currentPositionFilter = pos;
            loadOrders();
        };

        // PDF Generation
        window.downloadAdminInvoice = async (orderId) => {
            const docSnap = await getDoc(doc(db, "orders", orderId));
            if (docSnap.exists()) {
                const data = docSnap.data();
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({ unit: 'mm', format: [100, 150] });
                
                pdf.setFont("helvetica", "bold");
                pdf.setTextColor(5, 150, 105); 
                pdf.text("PMM WELFARE RECEIPT", 50, 15, { align: "center" });
                
                pdf.setTextColor(0, 0, 0);
                pdf.setFontSize(10);
                pdf.text(`Order ID: #${orderId.substring(0,8).toUpperCase()}`, 10, 30);
                pdf.text(`Status: ${data.status.toUpperCase()}`, 10, 35);
                pdf.text(`Date: ${data.createdAt?.toDate().toLocaleDateString()}`, 10, 40);
                
                pdf.text("------------------------------------------", 50, 45, { align: "center" });
                
                pdf.text(`Staff: ${data.staffName}`, 10, 55);
                pdf.text(`Role: ${data.userPosition}`, 10, 60);
                
                pdf.setFont("helvetica", "bold");
                pdf.text(`Item: ${data.itemName}`, 10, 75);
                pdf.setFont("helvetica", "normal");
                pdf.text(`Qty: ${data.qty}`, 10, 80);
                
                pdf.setFont("helvetica", "bold");
                pdf.text(`Welfare Price: Rs. ${data.total.toLocaleString()}`, 10, 95);
                
                pdf.setTextColor(5, 150, 105);
                pdf.text(`Total Staff Savings: Rs. ${data.savings.toLocaleString()}`, 10, 105);
                
                pdf.save(`Order_${orderId.substring(0,8)}.pdf`);
            }
        };

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "admin-login.html");
        });
        
        lucide.createIcons();
    </script>
</body>
</html>