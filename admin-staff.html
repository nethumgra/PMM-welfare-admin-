<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Management - PMM Welfare Shop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #F0FDF4; }
        ::-webkit-scrollbar-thumb { background: #059669; border-radius: 10px; }
        .modal-blur { backdrop-filter: blur(8px); }
        .sidebar-transition { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* Modal ඇතුලේ Scroll එක ලස්සන කිරීමට */
        .modal-content-scroll {
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-[#F0FDF4] text-[#064E3B] font-sans overflow-x-hidden">

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden backdrop-blur-sm"></div>

    <div id="editModal" class="fixed inset-0 bg-[#064E3B]/60 hidden z-[100] flex items-center justify-center p-4 modal-blur">
        <div class="bg-white w-full max-w-md rounded-[2.5rem] p-6 md:p-8 shadow-2xl border border-white/20 relative">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-black italic text-[#064E3B]">Edit Staff Member</h3>
                <button onclick="closeEditModal()" class="text-emerald-300 hover:text-red-500 transition">
                    <i data-lucide="x-circle" class="w-8 h-8"></i>
                </button>
            </div>
            
            <input type="hidden" id="editUid">
            <input type="hidden" id="editEmailHidden"> 
            
            <div class="modal-content-scroll space-y-4 px-1">
                <div class="flex flex-col items-center gap-3 p-4 bg-emerald-50 rounded-3xl border border-emerald-100">
                    <img id="editImagePreview" src="" class="w-20 h-20 rounded-2xl object-cover border-4 border-white shadow-md">
                    <div class="w-full text-center">
                        <label class="text-[9px] font-black text-[#059669] uppercase tracking-widest block mb-1">Change Profile Image</label>
                        <input type="file" id="editStaffImageInput" accept="image/*" class="text-[10px] w-full file:bg-emerald-600 file:text-white file:border-0 file:rounded-full file:px-3 file:py-1 cursor-pointer">
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-[#059669] uppercase ml-2 tracking-widest">Full Name</label>
                    <input type="text" id="editName" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm">
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-[#059669] uppercase ml-2 tracking-widest">EPF Number</label>
                        <input type="text" id="editEpf" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-[#059669] uppercase ml-2 tracking-widest">Status</label>
                        <select id="editStatus" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm">
                            <option value="Active">Active</option>
                            <option value="Inactive">Inactive</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-[#059669] uppercase ml-2 tracking-widest">Position</label>
                        <select id="editPosition" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm"></select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-[#059669] uppercase ml-2 tracking-widest">Location</label>
                        <select id="editLocation" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm"></select>
                    </div>
                </div>

                <div>
                    <label class="text-[10px] font-bold text-[#059669] uppercase ml-2 tracking-widest">Monthly Limit (Rs.)</label>
                    <input type="number" id="editLimit" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-black text-sm text-emerald-700">
                </div>

                <div class="pt-4 border-t border-emerald-50">
                    <button id="resetPassBtn" class="w-full bg-amber-50 text-amber-700 p-4 rounded-2xl font-bold text-[10px] border border-amber-100 hover:bg-amber-100 transition flex items-center justify-center gap-2">
                        <i data-lucide="mail-warning" class="w-4 h-4"></i> Reset Password Email
                    </button>
                </div>

                <button id="saveEditBtn" class="w-full bg-[#059669] text-white p-5 rounded-3xl font-black hover:bg-[#047857] transition shadow-xl mt-4 flex justify-center items-center gap-2">
                    <span id="editBtnText">Update Staff Details</span>
                    <div id="editLoader" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </button>
            </div>
        </div>
    </div>

    <!-- ORDER HISTORY MODAL -->
    <div id="historyModal" class="fixed inset-0 bg-[#064E3B]/70 hidden z-[100] flex items-center justify-center p-4 modal-blur">
        <div class="bg-white w-full max-w-3xl rounded-[2.5rem] shadow-2xl border border-white/20 overflow-hidden flex flex-col" style="max-height:90vh;">
            <!-- Header -->
            <div class="flex justify-between items-center p-6 md:p-8 border-b border-emerald-50 flex-shrink-0">
                <div class="flex items-center gap-4">
                    <img id="historyStaffImg" src="" class="w-12 h-12 rounded-2xl object-cover border-2 border-emerald-50 shadow-sm">
                    <div>
                        <h3 class="text-lg font-black text-[#064E3B]" id="historyStaffName">Staff Order History</h3>
                        <div id="historyStatsBadges" class="flex gap-2 mt-1"></div>
                    </div>
                </div>
                <button onclick="closeHistoryModal()" class="text-emerald-300 hover:text-red-500 transition flex-shrink-0">
                    <i data-lucide="x-circle" class="w-8 h-8"></i>
                </button>
            </div>

            <!-- Summary Bar -->
            <div id="historySummaryBar" class="hidden px-6 md:px-8 py-4 bg-[#F0FDF4] border-b border-emerald-100 grid grid-cols-3 gap-4 flex-shrink-0">
                <div class="text-center">
                    <p class="text-[10px] uppercase font-black text-emerald-500 tracking-widest">Total Orders</p>
                    <p class="text-xl font-black text-[#064E3B]" id="summaryTotalOrders">0</p>
                </div>
                <div class="text-center">
                    <p class="text-[10px] uppercase font-black text-emerald-500 tracking-widest">Total Spent</p>
                    <p class="text-xl font-black text-emerald-700" id="summaryTotalSpent">Rs. 0</p>
                </div>
                <div class="text-center">
                    <p class="text-[10px] uppercase font-black text-emerald-500 tracking-widest">Pending</p>
                    <p class="text-xl font-black text-amber-600" id="summaryPending">0</p>
                </div>
            </div>

            <!-- Loading -->
            <div id="historyLoader" class="flex flex-col items-center justify-center py-16 gap-3">
                <div class="w-8 h-8 border-4 border-emerald-200 border-t-emerald-600 rounded-full animate-spin"></div>
                <p class="text-xs font-bold text-emerald-400 uppercase tracking-widest">Loading Orders...</p>
            </div>

            <!-- Table -->
            <div id="historyTableWrap" class="hidden overflow-y-auto flex-1 px-6 md:px-8 pb-6">
                <table class="w-full text-left min-w-[500px] mt-4">
                    <thead class="sticky top-0 bg-white z-10">
                        <tr class="text-[#059669] text-[10px] uppercase tracking-widest border-b-2 border-[#F0FDF4]">
                            <th class="pb-3 pt-4">Order ID</th>
                            <th class="pb-3 pt-4">Items</th>
                            <th class="pb-3 pt-4">Date</th>
                            <th class="pb-3 pt-4">Total</th>
                            <th class="pb-3 pt-4">Status</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="text-sm font-medium divide-y divide-[#F0FDF4]"></tbody>
                </table>
                <div id="noHistory" class="hidden text-center py-16">
                    <i data-lucide="package-x" class="w-12 h-12 text-emerald-200 mx-auto mb-3"></i>
                    <p class="text-gray-400 font-black italic">No orders found for this staff member.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="flex min-h-screen relative">
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-[#064E3B] text-white transform -translate-x-full lg:translate-x-0 sidebar-transition shadow-2xl overflow-y-auto">
            <div class="p-8 text-center border-b border-emerald-800/50 flex justify-between items-center lg:justify-center">
                <h1 class="text-2xl font-black italic flex items-center gap-2"><i data-lucide="box"></i> PMM Welfare.</h1>
                <button onclick="toggleSidebar()" class="lg:hidden text-white/50 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <nav class="mt-6 px-4 space-y-2">
                <a href="admin.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition"><i data-lucide="layout-dashboard"></i> Dashboard</a>
                <a href="admin-bin-card.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition"><i data-lucide="clipboard-list"></i> Bin Card</a>
                <a href="admin-items.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition"><i data-lucide="package"></i> Store Items</a>
                <a href="admin-orders.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition"><i data-lucide="shopping-bag"></i> Orders</a>
                <a href="admin-staff.html" class="flex items-center gap-3 p-4 rounded-2xl bg-emerald-600/30 border border-emerald-500/30 transition group"><i data-lucide="users"></i> Staff Members</a>
                <a href="admin-settings.html" class="flex items-center gap-3 p-4 rounded-2xl hover:bg-emerald-600/20 transition group"><i data-lucide="settings"></i> System Settings</a>
                <div class="pt-10 pb-10">
                    <button id="logoutBtn" class="flex items-center gap-3 p-4 w-full rounded-2xl hover:bg-red-500 transition text-red-100"><i data-lucide="log-out"></i> Logout</button>
                </div>
            </nav>
        </aside>

        <main class="flex-1 lg:ml-72 p-4 md:p-8 lg:p-10">
            <header class="flex justify-between items-center mb-10">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden p-3 bg-white rounded-2xl shadow-sm text-[#059669]">
                        <i data-lucide="menu"></i>
                    </button>
                    <h2 class="text-2xl md:text-3xl font-black text-[#064E3B]">Staff & Directory</h2>
                </div>
                <div class="hidden sm:block bg-white py-2 px-6 rounded-2xl shadow-sm border border-[#DCFCE7]">
                    <p class="font-black text-[#064E3B]" id="adminNameDisplay">Admin</p>
                </div>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 md:p-8 rounded-[2.5rem] shadow-sm border border-[#DCFCE7]">
                        <h3 class="text-lg font-black mb-6 flex items-center gap-2 text-[#064E3B]"><i data-lucide="shield-plus" class="text-[#059669]"></i> <span id="roleFormTitle">Create Role</span></h3>
                        <div class="space-y-4">
                            <input type="hidden" id="editingRoleId">
                            <input type="text" id="newRoleName" placeholder="Ex: Manager" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm">
                            <input type="number" id="newRoleLimit" placeholder="Spend Limit (Rs.)" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-black text-sm">
                            <button id="addRoleBtn" class="w-full bg-[#059669] text-white p-4 rounded-2xl font-black hover:bg-[#047857] transition shadow-lg">Save Role</button>
                            <button id="cancelRoleEdit" class="hidden w-full bg-gray-100 text-gray-500 p-2 rounded-xl text-xs font-bold">Cancel Edit</button>
                        </div>
                        <div id="rolesList" class="mt-6 space-y-2"></div>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="bg-white p-6 md:p-8 rounded-[3rem] shadow-sm border border-[#DCFCE7]">
                        <h3 class="text-lg font-black mb-6 flex items-center gap-2 text-[#064E3B]"><i data-lucide="user-plus" class="text-[#059669]"></i> Register Staff Member</h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="staffName" placeholder="Full Name" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm">
                                <input type="text" id="staffEpf" placeholder="EPF Number" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <select id="staffLocation" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm">
                                    <option value="" disabled selected>Choose Location</option>
                                </select>
                                <select id="staffPosition" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm">
                                    <option value="" disabled selected>Choose Position</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" id="staffWhatsapp" placeholder="WhatsApp Number" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm">
                                <input type="email" id="staffEmail" placeholder="Login Email" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm">
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="password" id="staffPassword" placeholder="Temp Password" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-bold text-sm">
                                <input type="number" id="staffLimit" placeholder="Monthly Limit (Rs.)" class="w-full p-4 rounded-2xl bg-[#F0FDF4] border border-[#DCFCE7] font-black text-emerald-600 text-sm">
                            </div>
                            <div class="p-2 border border-dashed rounded-2xl border-emerald-200 bg-emerald-50/30">
                                <label class="text-[9px] font-bold text-emerald-600 block mb-1 ml-2">PROFILE IMAGE</label>
                                <input type="file" id="staffImage" accept="image/*" class="text-[10px] w-full px-2">
                            </div>
                            <button id="regStaffBtn" class="w-full bg-[#059669] text-white p-5 rounded-2xl font-black hover:bg-[#047857] transition shadow-xl flex justify-center items-center gap-2">
                                <span id="regBtnText">Register Staff Member</span>
                                <div id="regLoader" class="hidden w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-3">
                    <div class="bg-white p-6 md:p-8 rounded-[3rem] shadow-sm border border-[#DCFCE7]">
                        <h3 class="text-xl font-black text-[#064E3B] mb-6">Staff Directory</h3>
                        <div id="staffListDirectory" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp, deleteApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, setDoc, deleteDoc, updateDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB3jlpc_vbUydda2XpDj5Xd1J8kVei9v8U",
            authDomain: "inventory-c3cca.firebaseapp.com",
            projectId: "inventory-c3cca",
            storageBucket: "inventory-c3cca.firebasestorage.app",
            messagingSenderId: "396140403894",
            appId: "1:396140403894:web:316617b8e390f8b0575a17"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Sidebar Toggle
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        };

       onAuthStateChanged(auth, async (user) => {
    if (user) {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        const userData = userDoc.data();

        if (userData.role === "admin") {
            // පර්මිෂන් පරීක්ෂාව
            const hasAccess = userData.isSuperAdmin || userData.email === "admin@inventory.com" || (userData.permissions && userData.permissions.staff);

            if (hasAccess) {
                document.getElementById('adminNameDisplay').innerText = userData.name;
            } else {
                alert("ඔබට Staff Members පිටුවට පිවිසීමට අවසර නැත!");
                window.location.href = "admin.html";
            }
        } else { window.location.href = "admin-login.html"; }
    } else { window.location.href = "admin-login.html"; }
});

        // --- ROLE MANAGEMENT ---
        onSnapshot(collection(db, "roles"), (snap) => {
            const list = document.getElementById('rolesList');
            const staffPosSelect = document.getElementById('staffPosition'); 
            const editPosSelect = document.getElementById('editPosition');
            list.innerHTML = '';
            staffPosSelect.innerHTML = '<option value="" disabled selected>Choose Position</option>';
            editPosSelect.innerHTML = '<option value="" disabled selected>Choose Position</option>';
            
            snap.forEach(d => {
                const role = d.data();
                list.innerHTML += `
                    <div class="p-3 bg-emerald-50 rounded-xl border border-emerald-100 flex justify-between items-center group">
                        <div class="flex flex-col">
                            <span class="text-xs font-bold text-emerald-900">${role.name}</span>
                            <span class="text-[9px] font-black text-emerald-600">LIMIT: RS. ${role.monthlyLimit.toLocaleString()}</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="window.prepareRoleEdit('${d.id}', '${role.name}', ${role.monthlyLimit})" class="text-amber-400 hover:text-amber-600 transition">
                                <i data-lucide="pencil" class="w-3.5 h-3.5"></i>
                            </button>
                            <button onclick="window.deleteRole('${d.id}')" class="text-red-300 hover:text-red-500 transition">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
                            </button>
                        </div>
                    </div>`;
                const opt = `<option value="${role.name}">${role.name}</option>`;
                staffPosSelect.innerHTML += opt;
                editPosSelect.innerHTML += opt;
            });
            lucide.createIcons();
        });

        window.prepareRoleEdit = (id, name, limit) => {
            document.getElementById('editingRoleId').value = id;
            document.getElementById('newRoleName').value = name;
            document.getElementById('newRoleLimit').value = limit;
            document.getElementById('roleFormTitle').innerText = "Edit Role";
            document.getElementById('addRoleBtn').innerText = "Update Role";
            document.getElementById('cancelRoleEdit').classList.remove('hidden');
        };

        document.getElementById('cancelRoleEdit').addEventListener('click', () => {
            document.getElementById('editingRoleId').value = "";
            document.getElementById('newRoleName').value = "";
            document.getElementById('newRoleLimit').value = "";
            document.getElementById('roleFormTitle').innerText = "Create Role";
            document.getElementById('addRoleBtn').innerText = "Save Role";
            document.getElementById('cancelRoleEdit').classList.add('hidden');
        });

        document.getElementById('addRoleBtn').addEventListener('click', async () => {
            const id = document.getElementById('editingRoleId').value;
            const name = document.getElementById('newRoleName').value.trim();
            const limit = parseFloat(document.getElementById('newRoleLimit').value);
            
            if(!name || isNaN(limit)) return alert("කරුණාකර නම සහ limit ඇතුළත් කරන්න.");

            try {
                if(id) {
                    await updateDoc(doc(db, "roles", id), { name, monthlyLimit: limit });
                    alert("Role එක Update කළා!");
                } else {
                    await addDoc(collection(db, "roles"), { name, monthlyLimit: limit, createdAt: new Date() });
                    alert("Role එක සාර්ථකව හැදුවා!");
                }
                document.getElementById('cancelRoleEdit').click();
            } catch (e) { alert(e.message); }
        });

        window.deleteRole = async (id) => { if(confirm("මෙම Role එක මකා දැමීමට අවශ්‍යද?")) await deleteDoc(doc(db, "roles", id)); };

        // --- LOCATIONS ---
        onSnapshot(collection(db, "locations"), (snap) => {
            const selects = [document.getElementById('staffLocation'), document.getElementById('editLocation')];
            selects.forEach(s => {
                s.innerHTML = '<option value="" disabled selected>Choose Location</option>';
                snap.forEach(d => s.innerHTML += `<option value="${d.data().name}">${d.data().name}</option>`);
            });
        });

        // --- REGISTRATION ---
        document.getElementById('regStaffBtn').addEventListener('click', async () => {
            const btn = document.getElementById('regBtnText');
            const loader = document.getElementById('regLoader');
            const name = document.getElementById('staffName').value.trim();
            const email = document.getElementById('staffEmail').value.trim();
            const pass = document.getElementById('staffPassword').value.trim();
            const pos = document.getElementById('staffPosition').value;
            const locVal = document.getElementById('staffLocation').value;
            const limit = document.getElementById('staffLimit').value;

            if(!name || !email || !pass || !pos || !locVal) return alert("අත්‍යවශ්‍ය විස්තර සම්පූර්ණ කරන්න!");

            btn.innerText = "Processing..."; loader.classList.remove('hidden');

            try {
                let imgUrl = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
                const imgF = document.getElementById('staffImage').files[0];
                if(imgF) {
                    const fd = new FormData(); fd.append('image', imgF);
                    const res = await fetch('https://api.imgbb.com/1/upload?key=fb6365d6c7a493fa14ff7596b4e39e07', { method: 'POST', body: fd });
                    const j = await res.json(); imgUrl = j.data.display_url;
                }

                const secondaryApp = initializeApp(firebaseConfig, "SecondaryApp");
                const secondaryAuth = getAuth(secondaryApp);
                const cred = await createUserWithEmailAndPassword(secondaryAuth, email, pass);

                await setDoc(doc(db, "users", cred.user.uid), {
                    name, email, imageUrl: imgUrl, position: pos, location: locVal,
                    epfNumber: document.getElementById('staffEpf').value || "",
                    whatsapp: document.getElementById('staffWhatsapp').value || "",
                    monthlyLimit: parseFloat(limit) || 0,
                    role: "staff", status: "Active", createdAt: new Date()
                });

                await signOut(secondaryAuth); await deleteApp(secondaryApp);
                alert("ස්ටාෆ් සාමාජිකයා සාර්ථකව රෙජිස්ටර් කළා!");
                window.location.reload();
            } catch (e) { alert("Error: " + e.message); }
            finally { btn.innerText = "Register Staff Member"; loader.classList.add('hidden'); }
        });

        // --- DIRECTORY ---
        onSnapshot(query(collection(db, "users"), where("role", "==", "staff")), (snap) => {
            const dir = document.getElementById('staffListDirectory');
            dir.innerHTML = '';
            snap.forEach(d => {
                const s = d.data();
                dir.innerHTML += `
                    <div class="p-6 bg-white rounded-[2rem] border border-emerald-50 shadow-sm hover:shadow-lg transition-all group">
                        <div class="flex flex-col items-center text-center">
                            <img src="${s.imageUrl}" class="w-16 h-16 rounded-2xl object-cover mb-4 border-2 border-emerald-50 group-hover:border-emerald-200 transition">
                            <h4 onclick="window.viewHistory('${s.epfNumber}', '${s.name}', '${s.imageUrl}')" class="font-black text-sm text-[#064E3B] cursor-pointer hover:underline flex items-center justify-center gap-1">${s.name} <i data-lucide="history" class="w-3 h-3 text-emerald-400"></i></h4>
                            <p class="text-[9px] font-black uppercase text-emerald-600">${s.position} | ${s.location}</p>
                            <p class="text-[10px] font-bold text-gray-400 mt-1">${s.email}</p>
                            <span class="text-[8px] mt-2 px-2 py-0.5 rounded-full ${s.status === 'Active' ? 'bg-emerald-100 text-emerald-600' : 'bg-red-100 text-red-600'}">${s.status}</span>
                        </div>
                        <div class="mt-4 pt-4 border-t border-emerald-50 flex justify-between items-center">
                            <p class="text-[9px] font-bold text-gray-300 italic">EPF: ${s.epfNumber || '---'}</p>
                            <button onclick="window.openEditModal('${d.id}')" class="text-emerald-400 hover:text-emerald-700 transition">
                                <i data-lucide="settings-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>`;
            });
            lucide.createIcons();
        });

        // --- STAFF EDIT & PASSWORD RESET ---
        window.openEditModal = async (uid) => {
            const d = await getDoc(doc(db, "users", uid));
            const s = d.data();
            document.getElementById('editUid').value = uid;
            document.getElementById('editEmailHidden').value = s.email; 
            document.getElementById('editName').value = s.name;
            document.getElementById('editEpf').value = s.epfNumber || "";
            document.getElementById('editStatus').value = s.status;
            document.getElementById('editPosition').value = s.position;
            document.getElementById('editLocation').value = s.location || "";
            document.getElementById('editLimit').value = s.monthlyLimit || 0;
            document.getElementById('editImagePreview').src = s.imageUrl;
            document.getElementById('editModal').classList.remove('hidden');
        };

        window.closeEditModal = () => document.getElementById('editModal').classList.add('hidden');

        document.getElementById('resetPassBtn').addEventListener('click', async () => {
            const email = document.getElementById('editEmailHidden').value;
            if(!email) return alert("Email එකක් හමු වුණේ නැත.");
            
            if(confirm(`මෙම සාමාජිකයාගේ (${email}) password එක reset කිරීමට email එකක් යවන්නද?`)) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    alert("Password reset email එක සාර්ථකව යැවුවා. කරුණාකර ඔවුන්ගේ inbox එක පරීක්ෂා කරන්න කියන්න.");
                } catch (e) { alert("Error: " + e.message); }
            }
        });

        document.getElementById('saveEditBtn').addEventListener('click', async () => {
            const uid = document.getElementById('editUid').value;
            const btn = document.getElementById('editBtnText');
            const loader = document.getElementById('editLoader');
            btn.innerText = "Updating..."; loader.classList.remove('hidden');
            
            try {
                const up = {
                    name: document.getElementById('editName').value,
                    epfNumber: document.getElementById('editEpf').value,
                    status: document.getElementById('editStatus').value,
                    position: document.getElementById('editPosition').value,
                    location: document.getElementById('editLocation').value,
                    monthlyLimit: parseFloat(document.getElementById('editLimit').value) || 0
                };
                
                const imgFile = document.getElementById('editStaffImageInput').files[0];
                if(imgFile) {
                    const fd = new FormData(); fd.append('image', imgFile);
                    const res = await fetch('https://api.imgbb.com/1/upload?key=fb6365d6c7a493fa14ff7596b4e39e07', { method: 'POST', body: fd });
                    const json = await res.json(); up.imageUrl = json.data.display_url;
                }

                await updateDoc(doc(db, "users", uid), up);
                alert("සාර්ථකව Update කළා!");
                window.location.reload();
            } catch (e) { alert(e.message); }
            finally { btn.innerText = "Update Staff Details"; loader.classList.add('hidden'); }
        });

        // --- VIEW HISTORY ---
        let historyUnsubscribe = null;

        window.viewHistory = async (uid, name, imgUrl) => {
            // Show modal with loader
            document.getElementById('historyModal').classList.remove('hidden');
            document.getElementById('historyStaffName').innerText = name + "'s Orders";
            document.getElementById('historyStaffImg').src = imgUrl || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
            document.getElementById('historyLoader').classList.remove('hidden');
            document.getElementById('historyTableWrap').classList.add('hidden');
            document.getElementById('historySummaryBar').classList.add('hidden');
            document.getElementById('historyTableBody').innerHTML = '';
            document.getElementById('noHistory').classList.add('hidden');
            document.getElementById('historyStatsBadges').innerHTML = '';

            // Unsubscribe previous listener
            if(historyUnsubscribe) { historyUnsubscribe(); historyUnsubscribe = null; }

            const statusColors = {
                'Pending':   'bg-amber-100 text-amber-700',
                'Processing':'bg-blue-100 text-blue-700',
                'Completed': 'bg-emerald-100 text-emerald-700',
                'Cancelled': 'bg-red-100 text-red-600',
                'Approved':  'bg-emerald-100 text-emerald-700',
                'Rejected':  'bg-red-100 text-red-600'
            };

            const q = query(collection(db, "orders"), where("staffId", "==", uid), orderBy("createdAt", "desc"));

            historyUnsubscribe = onSnapshot(q, (snap) => {
                const table = document.getElementById('historyTableBody');
                const noHist = document.getElementById('noHistory');
                const loader = document.getElementById('historyLoader');
                const wrap = document.getElementById('historyTableWrap');
                const summaryBar = document.getElementById('historySummaryBar');

                loader.classList.add('hidden');

                if(snap.empty) {
                    wrap.classList.remove('hidden');
                    noHist.classList.remove('hidden');
                    lucide.createIcons();
                    return;
                }

                // Stats
                let totalSpent = 0, pending = 0;
                table.innerHTML = '';


snap.forEach(d => {
    const order = d.data();
    const displayOrderID = order.orderNo || ("ORD-" + d.id.substring(0, 5).toUpperCase());

    // 1. මෙම ඕඩර් එකේ ඇති Dispatched/Completed බඩු වල එකතුව පමණක් ගණනය කිරීම
    let orderActiveTotal = 0;
    
    if(order.status !== "Cancelled") {
        (order.items || []).forEach(item => {
            // Dashboard එකේ වගේම Dispatched හෝ Completed නම් පමණක් මුදල එකතු කරයි
            if(item.status === "Dispatched" || item.status === "Completed") {
                orderActiveTotal += (item.welfarePrice * item.qty);
            }
        });

        if(order.status === "Pending") pendingCount++;
    }
    
    // 2. සේවකයා ඇත්තටම වියදම් කළ මුළු මුදලට (Total Spent) මෙය එකතු කිරීම
    totalSpent += orderActiveTotal;

    const itemsHtml = (order.items || []).map(item => {
        const isRejected = item.status === 'Rejected';
        const isDispatched = item.status === 'Dispatched' || item.status === 'Completed';
        
        return `
            <div class="flex justify-between text-[10px] border-b border-emerald-50 py-1 last:border-0">
                <span class="font-bold ${isRejected ? 'line-through text-red-400' : ''}">${item.name} (x${item.qty})</span>
                <span class="font-black ${isRejected ? 'text-red-500' : (isDispatched ? 'text-emerald-600' : 'text-amber-500')}">
                    Rs. ${(item.welfarePrice * item.qty).toLocaleString()}
                </span>
            </div>`;
    }).join('');

    let statusClass = "bg-amber-100 text-amber-600";
    if(order.status === "Dispatched") statusClass = "bg-blue-100 text-blue-600";
    if(order.status === "Completed") statusClass = "bg-emerald-100 text-emerald-600";
    if(order.status === "Cancelled") statusClass = "bg-red-100 text-red-600";

    // Table Row එකේ Total එකටත් අපි පෙන්නන්නේ Active (Dispatched) වුණ මුදල පමණි
    table.innerHTML += `
        <tr class="hover:bg-emerald-50/50 transition">
            <td class="py-4 font-black text-[#059669] text-xs">${displayOrderID}</td>
            <td class="py-4 min-w-[150px]">
                <div class="bg-white p-2 rounded-xl border border-emerald-100 shadow-sm">${itemsHtml}</div>
            </td>
            <td class="py-4 text-[11px] font-bold text-gray-400">${order.createdAt?.toDate().toLocaleDateString() || 'Today'}</td>
            <td class="py-4 font-black text-[#064E3B]">Rs. ${orderActiveTotal.toLocaleString()}</td>
            <td class="py-4 text-center">
                <span class="px-3 py-1 rounded-full text-[9px] font-black uppercase tracking-widest ${statusClass}">${order.status}</span>
            </td>
        </tr>`;
});

                // Summary
                document.getElementById('summaryTotalOrders').innerText = snap.size;
               document.getElementById('summaryTotalSpent').innerText = 'Rs. ' + totalSpent.toLocaleString();
                document.getElementById('summaryPending').innerText = pending;
                summaryBar.classList.remove('hidden');
                summaryBar.style.display = 'grid';
                wrap.classList.remove('hidden');
                lucide.createIcons();
            });
        };

        window.closeHistoryModal = () => {
            document.getElementById('historyModal').classList.add('hidden');
            if(historyUnsubscribe) { historyUnsubscribe(); historyUnsubscribe = null; }
        };

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth).then(() => window.location.href = "admin-login.html"));
        lucide.createIcons();
    </script>
</body>
</html>